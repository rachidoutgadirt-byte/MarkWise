<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MarkWise - نظام ZipGrade المتطور</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#4f46e5', secondary: '#4338ca', surface: '#f8fafc', success: '#22c55e', error: '#ef4444' },
                    fontFamily: { sans: ['Tajawal', 'sans-serif'], display: ['Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <!-- OpenCV & Tools -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        body { background-color: #f3f4f6; overflow-x: hidden; touch-action: pan-y; }
        
        /* --- ZipGrade Style Overlay --- */
        .corner-guide {
            position: absolute; width: 60px; height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.4);
            transition: all 0.2s ease; z-index: 20;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .corner-guide.locked {
            border-color: #22c55e; /* Green when detected */
            background-color: rgba(34, 197, 94, 0.2);
            transform: scale(1.1);
        }
        /* Corners positioning */
        .guide-tl { top: 10%; left: 10%; border-radius: 0 0 16px 0; border-left: 0; border-top: 0; border-right: 4px solid; border-bottom: 4px solid; transform: rotate(180deg); }
        .guide-tr { top: 10%; right: 10%; border-radius: 0 0 0 16px; border-right: 0; border-top: 0; border-left: 4px solid; border-bottom: 4px solid; transform: rotate(180deg); }
        .guide-bl { bottom: 10%; left: 10%; border-radius: 0 16px 0 0; border-left: 0; border-bottom: 0; border-right: 4px solid; border-top: 4px solid; transform: rotate(180deg); }
        .guide-br { bottom: 10%; right: 10%; border-radius: 16px 0 0 0; border-right: 0; border-bottom: 0; border-left: 4px solid; border-top: 4px solid; transform: rotate(180deg); }

        /* --- Paper Styles --- */
        #printableArea { width: 210mm; min-height: 297mm; background: white; margin: 0 auto; overflow: hidden; position: relative; }
        .bubble { width: 24px; height: 24px; border: 2px solid #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 11px; font-weight: bold; }
        .bubble.correct { background: #22c55e; color: white; border-color: #22c55e; }
        .bubble.wrong { background: #ef4444; color: white; border-color: #ef4444; }
        
        /* Markers for printing */
        .scan-marker { width: 20px; height: 20px; background: black; position: absolute; z-index: 50; }
        
        /* Snapshot Image in Results */
        .name-snapshot { height: 40px; border: 1px solid #ccc; border-radius: 4px; object-fit: cover; }
    </style>
</head>
<body class="font-sans min-h-screen flex flex-col">

<audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"></audio>

<!-- Loading & Modals -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/90 z-[9999] hidden flex-col items-center justify-center text-white">
    <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
    <h2 class="text-xl font-bold">جارٍ المعالجة...</h2>
</div>

<!-- Header -->
<div class="container mx-auto px-4 py-4">
    <header class="bg-white rounded-2xl shadow-sm p-4 mb-4 flex flex-col md:flex-row justify-between items-center border-b-4 border-primary">
        <div class="flex items-center gap-4">
            <div class="bg-primary p-3 rounded-xl text-white"><i class="fa-solid fa-qrcode fa-2x"></i></div>
            <div>
                <h1 class="text-2xl font-bold text-gray-800">MarkWise <span class="text-primary text-sm">Pro</span></h1>
                <p class="text-xs font-bold text-gray-500 mt-1 flex gap-2 items-center">
                    <span id="cvStatus" class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px]">جاري تحميل المحرك...</span>
                </p>
            </div>
        </div>
        <div class="flex gap-2 mt-4 md:mt-0">
            <button onclick="resetApp()" class="px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 font-bold text-sm"><i class="fa-solid fa-trash"></i> تهيئة</button>
        </div>
    </header>

    <!-- Navigation -->
    <div class="bg-white rounded-xl shadow-sm mb-6 p-1 flex overflow-x-auto gap-1">
        <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn active px-4 py-2 rounded-lg font-bold text-sm flex-1 whitespace-nowrap bg-primary text-white">الإعدادات</button>
        <button onclick="switchTab('design')" id="tab-design" class="tab-btn px-4 py-2 rounded-lg font-bold text-sm flex-1 whitespace-nowrap text-gray-500 hover:bg-gray-50">الطباعة</button>
        <button onclick="switchTab('scan')" id="tab-scan" class="tab-btn px-4 py-2 rounded-lg font-bold text-sm flex-1 whitespace-nowrap text-gray-500 hover:bg-gray-50">الماسح الضوئي</button>
        <button onclick="switchTab('results')" id="tab-results" class="tab-btn px-4 py-2 rounded-lg font-bold text-sm flex-1 whitespace-nowrap text-gray-500 hover:bg-gray-50">النتائج</button>
    </div>

    <!-- 1. SETTINGS TAB -->
    <div id="settings" class="section-panel block space-y-4">
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="font-bold text-lg mb-4 text-primary border-b pb-2">بيانات الفرض</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="conf-school" class="border p-3 rounded-lg w-full" placeholder="اسم المؤسسة">
                <input type="text" id="conf-teacher" class="border p-3 rounded-lg w-full" placeholder="اسم الأستاذ">
                <input type="text" id="conf-subject" class="border p-3 rounded-lg w-full" placeholder="المادة">
                <input type="text" id="conf-title" class="border p-3 rounded-lg w-full" placeholder="عنوان الفرض (مثال: فرض 1)">
            </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-primary">سلم التنقيط</h3>
                <div class="flex gap-2">
                    <div class="bg-gray-100 px-3 py-1 rounded">
                        <span class="text-xs font-bold text-gray-500">عدد الأسئلة:</span>
                        <input type="number" id="conf-q" value="10" min="1" max="50" class="w-12 bg-transparent text-center font-bold outline-none" onchange="updateKeyGrid()">
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto border rounded-lg max-h-[400px]">
                <table class="w-full text-center text-sm">
                    <thead class="bg-gray-100 sticky top-0"><tr><th class="p-3">س</th><th class="p-3">الإجابة الصحيحة</th><th class="p-3">النقطة</th></tr></thead>
                    <tbody id="key-grid-body" class="divide-y"></tbody>
                </table>
            </div>
            <button onclick="saveSettings()" class="w-full bg-primary text-white py-3 rounded-xl font-bold mt-4 shadow-lg">حفظ الإعدادات</button>
        </div>
    </div>

    <!-- 2. DESIGN TAB -->
    <div id="design" class="section-panel hidden">
        <div class="flex justify-between items-center mb-4 bg-white p-3 rounded-xl shadow-sm">
            <span class="font-bold text-sm">معاينة الورقة</span>
            <button onclick="printPaper()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm"><i class="fa-solid fa-print"></i> طباعة PDF</button>
        </div>
        <div class="bg-gray-200 p-4 rounded-xl overflow-auto flex justify-center min-h-[600px]">
            <div id="printableArea"></div>
        </div>
    </div>

    <!-- 3. SCAN TAB (ZipGrade Style) -->
    <div id="scan" class="section-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 relative">
                <!-- Camera Container -->
                <div class="bg-black rounded-xl overflow-hidden relative shadow-2xl aspect-[3/4] md:aspect-[4/3]">
                    <video id="videoFeed" class="w-full h-full object-cover" playsinline muted></video>
                    
                    <!-- ZipGrade GUIDES -->
                    <div id="scan-overlay" class="absolute inset-0 pointer-events-none hidden">
                        <!-- Corner Boxes -->
                        <div id="guide-tl" class="corner-guide guide-tl"></div>
                        <div id="guide-tr" class="corner-guide guide-tr"></div>
                        <div id="guide-bl" class="corner-guide guide-bl"></div>
                        <div id="guide-br" class="corner-guide guide-br"></div>
                        
                        <!-- Center hint -->
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white/80 text-center">
                            <div class="w-1 h-12 bg-white/20 mx-auto mb-2"></div>
                            <span id="scan-hint" class="bg-black/50 px-3 py-1 rounded text-xs">ضع العلامات داخل المربعات</span>
                            <div class="w-1 h-12 bg-white/20 mx-auto mt-2"></div>
                        </div>
                    </div>

                    <!-- Start Camera Button -->
                    <div id="cam-start-btn" class="absolute inset-0 flex items-center justify-center bg-gray-900 z-30">
                        <button onclick="startCamera()" class="bg-primary text-white px-8 py-4 rounded-full font-bold shadow-lg hover:scale-105 transition flex items-center gap-3">
                            <i class="fa-solid fa-camera"></i> تشغيل الكاميرا
                        </button>
                        <!-- File Upload Fallback -->
                        <label class="absolute bottom-10 text-gray-400 cursor-pointer text-sm">
                            <i class="fa-solid fa-image"></i> تحميل صورة يدوياً
                            <input type="file" hidden accept="image/*" onchange="handleFileUpload(event)">
                        </label>
                    </div>

                    <!-- Result Popup -->
                    <div id="result-popup" class="absolute inset-0 z-40 bg-black/90 hidden flex-col items-center justify-center p-6">
                        <h2 class="text-white text-2xl font-bold mb-4">تم التصحيح!</h2>
                        <div class="flex gap-4 mb-4 w-full h-32 justify-center">
                            <!-- Show Cropped Name Header -->
                            <div class="bg-white p-1 rounded">
                                <p class="text-[10px] text-center mb-1">بيانات التلميذ</p>
                                <img id="popup-name-img" class="h-full object-contain max-w-[150px]">
                            </div>
                            <!-- Score -->
                            <div class="bg-white p-4 rounded flex flex-col justify-center items-center min-w-[100px]">
                                <span class="text-4xl font-black text-primary" id="popup-score">0</span>
                                <span class="text-xs text-gray-500 font-bold">المجموع</span>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="nextScan()" class="bg-primary text-white px-8 py-3 rounded-full font-bold">التالي</button>
                            <button onclick="discardResult()" class="bg-red-600 text-white px-4 py-3 rounded-full"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Results Sidebar -->
            <div class="lg:col-span-1 bg-white rounded-xl shadow-sm p-4 h-[500px] flex flex-col">
                <h3 class="font-bold border-b pb-2 mb-2">النتائج الحديثة</h3>
                <div id="recent-list" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
            </div>
        </div>
    </div>

    <!-- 4. RESULTS TAB -->
    <div id="results" class="section-panel hidden bg-white rounded-xl shadow-sm p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg">قائمة النتائج التفصيلية</h3>
            <button onclick="exportCSV()" class="bg-green-600 text-white px-4 py-2 rounded font-bold text-xs">Excel تصدير</button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-right">
                <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                    <tr><th class="p-3">الهوية (صورة)</th><th class="p-3">النقطة</th><th class="p-3">النسبة</th><th class="p-3">التوقيت</th><th class="p-3">حذف</th></tr>
                </thead>
                <tbody id="results-table-body" class="text-sm divide-y"></tbody>
            </table>
        </div>
    </div>

</div>

<!-- Hidden Canvas for Processing -->
<canvas id="procCanvas" class="hidden"></canvas>

<script>
    /* --- APPLICATION STATE --- */
    const app = {
        settings: { school: '', teacher: '', subject: '', title: '', q: 10, keys: [] },
        results: [],
        cvReady: false,
        isScanning: false,
        stream: null,
        labels: ['A','B','C','D'],
        // Coordinates for A4 Standard (Design Specific)
        PAPER_W: 1000, PAPER_H: 1414,
        // Header Crop Area (Top 15% of paper, avoiding markers)
        HEADER_RECT: { x: 100, y: 150, w: 800, h: 150 } 
    };

    /* --- INITIALIZATION --- */
    function onOpenCvReady() {
        app.cvReady = true;
        document.getElementById('cvStatus').innerText = "المحرك جاهز";
        document.getElementById('cvStatus').className = "bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold";
    }
    window.onload = () => { updateKeyGrid(); loadData(); };

    function switchTab(id) {
        document.querySelectorAll('.section-panel').forEach(p => p.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('bg-primary', 'text-white'); b.classList.add('text-gray-500'); });
        document.getElementById('tab-'+id).classList.remove('text-gray-500');
        document.getElementById('tab-'+id).classList.add('bg-primary', 'text-white');
        if(id !== 'scan') stopCamera();
        if(id === 'results') renderResults();
    }

    /* --- SETTINGS LOGIC --- */
    function updateKeyGrid() {
        const q = parseInt(document.getElementById('conf-q').value);
        const b = document.getElementById('key-grid-body'); b.innerHTML = '';
        app.settings.keys = app.settings.keys.slice(0, q);
        for(let i=0; i<q; i++) {
            let opts = '';
            for(let j=0; j<4; j++) {
                opts += `<label class="inline-flex items-center justify-center w-8 h-8 mx-1 border rounded-full cursor-pointer hover:bg-gray-100"><input type="radio" name="k${i}" value="${j}" class="hidden peer"><span class="peer-checked:bg-black peer-checked:text-white w-full h-full rounded-full flex items-center justify-center font-bold text-gray-500">${app.labels[j]}</span></label>`;
            }
            b.innerHTML += `<tr><td class="p-2 font-bold">${i+1}</td><td class="p-2">${opts}</td><td class="p-2"><input type="number" id="p${i}" value="1" class="w-12 text-center border rounded"></td></tr>`;
        }
    }
    
    function saveSettings() {
        const q = parseInt(document.getElementById('conf-q').value);
        app.settings.school = document.getElementById('conf-school').value;
        app.settings.teacher = document.getElementById('conf-teacher').value;
        app.settings.subject = document.getElementById('conf-subject').value;
        app.settings.title = document.getElementById('conf-title').value;
        app.settings.q = q;
        app.settings.keys = [];
        for(let i=0; i<q; i++) {
            const ch = document.querySelector(`input[name="k${i}"]:checked`);
            app.settings.keys.push({ ans: ch ? parseInt(ch.value) : 0, pts: parseFloat(document.getElementById(`p${i}`).value)||1 });
        }
        localStorage.setItem('mw_settings', JSON.stringify(app.settings));
        generatePaperHTML(); // Auto update print view
        alert("تم الحفظ");
        switchTab('design');
    }

    /* --- GENERATE PAPER (FIXED MARKERS) --- */
    function generatePaperHTML() {
        const s = app.settings;
        let html = `
        <div style="width:210mm; height:297mm; padding:15mm; position:relative; box-sizing:border-box;">
            <!-- MARKERS: Fixed at corners (15mm from edge) -->
            <div class="scan-marker" style="top:15mm; left:15mm;"></div>
            <div class="scan-marker" style="top:15mm; right:15mm;"></div>
            <div class="scan-marker" style="bottom:15mm; left:15mm;"></div>
            <div class="scan-marker" style="bottom:15mm; right:15mm;"></div>

            <!-- HEADER (Identity Area) -->
            <div class="text-center mb-6 mt-4 border-b-2 border-black pb-2">
                <h1 class="font-bold text-xl">${s.school}</h1>
                <div class="flex justify-between items-end mt-2">
                    <div class="text-right text-xs"><b>الأستاذ:</b> ${s.teacher}</div>
                    <div class="text-center"><span class="bg-black text-white px-3 py-1 rounded text-sm font-bold">${s.subject} - ${s.title}</span></div>
                    <div class="text-left text-xs"><b>ID:</b> ${Math.floor(Math.random()*9999)}</div>
                </div>
            </div>
            
            <!-- HANDWRITING AREA (Important for cropping) -->
            <div class="border-2 border-dashed border-gray-400 rounded p-4 mb-6 bg-gray-50 flex gap-4" id="identity-box">
                <div class="flex-1 text-right">
                    <span class="font-bold text-sm text-gray-600">الاسم الكامل:</span>
                    <div class="border-b border-black mt-6"></div>
                </div>
                <div class="w-1/3 text-right">
                    <span class="font-bold text-sm text-gray-600">القسم / الرقم:</span>
                    <div class="border-b border-black mt-6"></div>
                </div>
            </div>

            <!-- BUBBLES GRID -->
            <div class="grid grid-cols-2 gap-x-8 gap-y-2 direction-ltr" dir="ltr">`;
            
        for(let i=0; i<s.q; i++) {
            let bubs = '';
            for(let j=0; j<4; j++) bubs += `<div class="bubble">${app.labels[j]}</div>`;
            html += `<div class="flex items-center justify-between border-b py-1"><span class="font-bold w-6">${i+1}</span><div class="flex gap-2">${bubs}</div></div>`;
        }
        
        html += `</div>
            <div class="absolute bottom-5 left-0 w-full text-center text-[10px] text-gray-400">Powered by MarkWise</div>
        </div>`;
        document.getElementById('printableArea').innerHTML = html;
    }

    async function printPaper() {
        const el = document.getElementById('printableArea');
        const canvas = await html2canvas(el, {scale:2});
        const pdf = new jspdf.jsPDF('p','mm','a4');
        pdf.addImage(canvas.toDataURL('image/jpeg'), 'JPEG', 0, 0, 210, 297);
        pdf.save('exam_paper.pdf');
    }

    /* --- ZIPGRADE SCANNING LOGIC --- */
    async function startCamera() {
        try {
            app.stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} } 
            });
            const vid = document.getElementById('videoFeed');
            vid.srcObject = app.stream;
            vid.onloadedmetadata = () => {
                vid.play();
                document.getElementById('cam-start-btn').classList.add('hidden');
                document.getElementById('scan-overlay').classList.remove('hidden');
                app.isScanning = true;
                requestAnimationFrame(scanLoop);
            };
        } catch(e) { alert("تعذر فتح الكاميرا"); }
    }

    function stopCamera() {
        app.isScanning = false;
        if(app.stream) app.stream.getTracks().forEach(t=>t.stop());
        document.getElementById('cam-start-btn').classList.remove('hidden');
        document.getElementById('scan-overlay').classList.add('hidden');
    }

    // MAIN SCAN LOOP
    let frameCount = 0;
    function scanLoop() {
        if(!app.isScanning || !app.cvReady) return;
        
        const vid = document.getElementById('videoFeed');
        if(vid.readyState === vid.HAVE_ENOUGH_DATA) {
            frameCount++;
            // Process every 3rd frame to save battery/cpu
            if(frameCount % 3 === 0) {
                processFrame(vid);
            }
        }
        requestAnimationFrame(scanLoop);
    }

    function processFrame(video) {
        // Create a small working canvas
        const canvas = document.getElementById('procCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 640; // Downscale for speed
        canvas.height = 360; // 16:9 aspect
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Define ROIs (Regions of Interest) based on CSS Guide positions
        // Guides are at 10% margins.
        const W = canvas.width;
        const H = canvas.height;
        const BOX_SIZE = W * 0.15; // 15% width box
        
        // Coordinates of the 4 corner boxes in the scaled canvas
        const rois = [
            { x: W*0.1, y: H*0.1, w: BOX_SIZE, h: BOX_SIZE, el: 'guide-tl' }, // Top Left
            { x: W*0.9 - BOX_SIZE, y: H*0.1, w: BOX_SIZE, h: BOX_SIZE, el: 'guide-tr' }, // Top Right
            { x: W*0.1, y: H*0.9 - BOX_SIZE, w: BOX_SIZE, h: BOX_SIZE, el: 'guide-bl' }, // Bottom Left
            { x: W*0.9 - BOX_SIZE, y: H*0.9 - BOX_SIZE, w: BOX_SIZE, h: BOX_SIZE, el: 'guide-br' } // Bottom Right
        ];

        let src = cv.imread(canvas);
        let gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
        
        // Threshold
        let thresh = new cv.Mat();
        cv.threshold(gray, thresh, 80, 255, cv.THRESH_BINARY_INV);

        let lockedCount = 0;
        let corners = [];

        // Check each ROI
        rois.forEach((roi, idx) => {
            // Crop the ROI
            let roiRect = new cv.Rect(roi.x, roi.y, roi.w, roi.h);
            let roiMat = thresh.roi(roiRect);
            
            // Find contours in this small box
            let cnts = new cv.MatVector();
            cv.findContours(roiMat, cnts, new cv.Mat(), cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
            
            let found = false;
            let center = { x: 0, y: 0 };

            for(let i=0; i<cnts.size(); i++) {
                let c = cnts.get(i);
                let area = cv.contourArea(c);
                // Expected marker size relative to ROI
                if(area > 100 && area < (roi.w*roi.h)*0.8) {
                    let rect = cv.boundingRect(c);
                    let ar = rect.width / rect.height;
                    // Is square-ish?
                    if(ar > 0.7 && ar < 1.3) {
                        found = true;
                        // Save global center coordinate
                        center.x = roi.x + rect.x + rect.width/2;
                        center.y = roi.y + rect.y + rect.height/2;
                        break; // Found the marker in this corner
                    }
                }
            }
            
            // Visual Feedback
            const el = document.getElementById(roi.el);
            if(found) {
                el.classList.add('locked');
                corners[idx] = center; // Store precise point
                lockedCount++;
            } else {
                el.classList.remove('locked');
            }
            
            roiMat.delete(); cnts.delete();
        });

        // Trigger Grading if all 4 found
        if(lockedCount === 4) {
            document.getElementById('scan-hint').innerText = "جاري المعالجة...";
            document.getElementById('beepSound').play().catch(()=>{});
            
            // Perform Warp & Grade using the 'corners' array
            performGrading(gray, corners);
            app.isScanning = false; // Pause scanning
        } else {
            document.getElementById('scan-hint').innerText = "ضع العلامات داخل المربعات";
        }

        src.delete(); gray.delete(); thresh.delete();
    }

    function performGrading(grayMat, corners) {
        // 1. Perspective Warp
        // corners = [TL, TR, BL, BR] (based on ROI index order)
        let srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
            corners[0].x, corners[0].y,
            corners[1].x, corners[1].y,
            corners[2].x, corners[2].y,
            corners[3].x, corners[3].y
        ]);
        
        // Target: Standard A4 Ratio (1000 x 1414)
        // Markers are at 15mm from edge. 
        // Paper width 210mm. Marker offset px = (15/210)*1000 = ~71px
        const pad = 71;
        const W = app.PAPER_W;
        const H = app.PAPER_H;
        
        let dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
            pad, pad,
            W-pad, pad,
            pad, H-pad,
            W-pad, H-pad
        ]);
        
        let M = cv.getPerspectiveTransform(srcTri, dstTri);
        let warped = new cv.Mat();
        cv.warpPerspective(grayMat, warped, M, new cv.Size(W, H));
        
        // 2. Crop Name Header
        let nameImgData = null;
        try {
            // HEADER_RECT defined in app state
            let headerRoi = warped.roi(new cv.Rect(app.HEADER_RECT.x, app.HEADER_RECT.y, app.HEADER_RECT.w, app.HEADER_RECT.h));
            let headerCanvas = document.createElement('canvas');
            headerCanvas.width = app.HEADER_RECT.w;
            headerCanvas.height = app.HEADER_RECT.h;
            cv.imshow(headerCanvas, headerRoi);
            nameImgData = headerCanvas.toDataURL('image/jpeg', 0.8);
            headerRoi.delete();
        } catch(e) { console.log("Header crop fail"); }

        // 3. Grade Bubbles
        // Threshold warped image for bubble detection
        let bin = new cv.Mat();
        cv.threshold(warped, bin, 0, 255, cv.THRESH_BINARY_INV | cv.THRESH_OTSU);
        
        const q = app.settings.q;
        let score = 0;
        // Grid logic: 2 columns in HTML. 
        // Left col: x= ~150 to 450. Right col: x= ~550 to 850.
        // Y starts approx 350px down.
        const startY = 350;
        const rowH = (1200 - startY) / Math.ceil(q/2);
        
        // Simple logic for single column for demo stability (adjust x coordinates for 2 cols)
        // Let's assume 2 cols layout like the HTML generator
        let answers = [];
        
        for(let i=0; i<q; i++) {
            let col = (i < Math.ceil(q/2)) ? 0 : 1; // 0=Left, 1=Right
            let idxInCol = (col===0) ? i : i - Math.ceil(q/2);
            
            // Coordinates tuned for 1000px width
            let xStart = (col===0) ? 180 : 600; 
            let yPos = startY + (idxInCol * rowH);
            let optW = 40; // distance between bubbles
            
            let detected = -1;
            let maxPix = 0;
            
            for(let j=0; j<4; j++) {
                let cx = xStart + (j * 50); // 50px gap
                let cy = yPos + (rowH/2);
                
                // ROI for bubble
                let r = 12;
                let roi = bin.roi(new cv.Rect(cx-r, cy-r, r*2, r*2));
                let count = cv.countNonZero(roi);
                roi.delete();
                
                if(count > 150 && count > maxPix) { // Threshold
                    maxPix = count;
                    detected = j;
                }
            }
            
            // Grading
            const key = app.settings.keys[i];
            if(detected === key.ans) score += key.pts;
            answers.push(detected);
        }

        // 4. Save & Show Result
        const res = {
            id: Date.now(),
            score: score,
            total: app.settings.keys.reduce((a,b)=>a+b.pts,0),
            nameImg: nameImgData, // The handwritten snapshot
            date: new Date().toLocaleTimeString('ar-MA')
        };
        app.results.push(res);
        saveData();

        // UI Update
        document.getElementById('successSound').play().catch(()=>{});
        document.getElementById('popup-score').innerText = res.score;
        document.getElementById('popup-name-img').src = res.nameImg;
        document.getElementById('result-popup').classList.remove('hidden');
        document.getElementById('result-popup').classList.add('flex');
        
        updateRecentList();

        // Cleanup
        srcTri.delete(); dstTri.delete(); M.delete(); warped.delete(); bin.delete();
    }

    function updateRecentList() {
        const list = document.getElementById('recent-list');
        list.innerHTML = '';
        [...app.results].reverse().forEach(r => {
            list.innerHTML += `
            <div class="flex items-center gap-3 p-2 bg-gray-50 rounded border-r-4 border-primary">
                <img src="${r.nameImg}" class="w-16 h-10 object-cover border bg-white rounded">
                <div class="flex-1">
                    <div class="font-bold text-lg">${r.score} / ${r.total}</div>
                    <div class="text-xs text-gray-400">${r.date}</div>
                </div>
            </div>`;
        });
    }

    function nextScan() {
        document.getElementById('result-popup').classList.add('hidden');
        document.getElementById('result-popup').classList.remove('flex');
        app.isScanning = true;
        requestAnimationFrame(scanLoop);
    }

    function discardResult() {
        app.results.pop();
        saveData();
        updateRecentList();
        nextScan();
    }
    
    /* --- RESULTS TAB --- */
    function renderResults() {
        const tbody = document.getElementById('results-table-body');
        tbody.innerHTML = '';
        app.results.forEach((r, idx) => {
            const pct = Math.round((r.score/r.total)*100);
            tbody.innerHTML += `
            <tr class="hover:bg-gray-50">
                <td class="p-3"><img src="${r.nameImg}" class="name-snapshot hover:scale-150 transition cursor-zoom-in bg-white"></td>
                <td class="p-3 font-bold text-primary">${r.score}</td>
                <td class="p-3"><span class="px-2 py-1 rounded text-xs ${pct>=50?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${pct}%</span></td>
                <td class="p-3 text-gray-500">${r.date}</td>
                <td class="p-3"><button onclick="deleteRes(${idx})" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fa-solid fa-trash"></i></button></td>
            </tr>`;
        });
    }

    function deleteRes(idx) {
        if(confirm("حذف النتيجة؟")) {
            app.results.splice(idx, 1);
            saveData();
            renderResults();
        }
    }

    function exportCSV() {
        // Since we don't have text names, we export ID and Score
        let csv = "\uFEFFID,Score,Total,Date\n";
        app.results.forEach(r => { csv += `${r.id},${r.score},${r.total},${r.date}\n`; });
        const a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
        a.download = 'results.csv';
        a.click();
    }

    /* --- STORAGE --- */
    function saveData() { localStorage.setItem('mw_results', JSON.stringify(app.results)); }
    function loadData() {
        if(localStorage.getItem('mw_settings')) app.settings = JSON.parse(localStorage.getItem('mw_settings'));
        if(localStorage.getItem('mw_results')) app.results = JSON.parse(localStorage.getItem('mw_results'));
        updateRecentList();
    }
    function resetApp() { localStorage.clear(); location.reload(); }
    
    // Manual file upload fallback
    function handleFileUpload(e) {
        const f = e.target.files[0];
        if(!f) return;
        stopCamera();
        const img = new Image();
        img.src = URL.createObjectURL(f);
        img.onload = () => {
            // Process manually by drawing to procCanvas and calling detect
            const canvas = document.getElementById('procCanvas');
            canvas.width = img.width; canvas.height = img.height;
            canvas.getContext('2d').drawImage(img,0,0);
            // We skip the UI ROI check for uploads and try to find markers globally (simplified) or just tell user to use camera
            alert("يرجى استخدام الكاميرا للحصول على أفضل النتائج مع ميزة ZipGrade");
            // For code brevity, sticking to camera loop logic
        };
    }
</script>
</body>
</html>
