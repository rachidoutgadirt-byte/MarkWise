<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMR Master Pro V10.0 - المصحح الآلي الذكي</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#2563eb', secondary: '#1e40af', surface: '#f8fafc', success: '#22c55e', error: '#ef4444', warning: '#f59e0b' },
                    fontFamily: { sans: ['Tajawal', 'sans-serif'], display: ['Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <!-- Libraries -->
    <!-- OpenCV (Essential for image processing) -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady()"></script>
    <!-- jsPDF & html2canvas for Printing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Chart.js for Statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- TinyMCE for Question Editing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        /* PDF Paper Layout */
        .paper-sheet {
            width: 210mm; min-height: 297mm; background: white; margin: 0 auto;
            box-shadow: 0 0 25px rgba(0,0,0,0.1); display: flex; flex-direction: row;
            overflow: hidden; position: relative;
        }
        
        /* Compact Mode for Answer Sheet Only */
        .paper-sheet.compact-mode .q-row {
            display: inline-flex; width: 48%; margin: 4px 1%; border-bottom: 1px solid #eee;
            align-items: center; justify-content: space-between; padding: 5px;
        }

        /* Sidebar Styles */
        .vertical-sidebar {
            width: 15mm; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-left: 1px dashed #cbd5e1; border-right: 1px dashed #cbd5e1;
            padding: 20px 0; overflow: hidden;
        }
        .rotated-text {
            transform: rotate(-90deg); white-space: nowrap; font-family: 'Cairo', sans-serif;
            font-weight: 700; font-size: 14px; margin: 15px 0; letter-spacing: 0.5px;
        }
        
        /* Bubbles & Feedback */
        .bubble-container { display: flex; justify-content: center; gap: 6px; }
        .bubble {
            width: 26px; height: 26px; border: 2px solid #334155; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: 800; font-family: 'Arial', sans-serif;
            background: white; z-index: 10; transition: all 0.2s;
        }
        /* Result Coloring */
        .bubble.correct { background-color: #22c55e !important; border-color: #22c55e; color: white; }
        .bubble.wrong { background-color: #ef4444 !important; border-color: #ef4444; color: white; }
        .bubble.missed { background-color: #fbbf24 !important; border-color: #d97706; }
        .bubble.student-select { background-color: #3b82f6; border-color: #2563eb; color: white; } /* Just for view */
        
        /* Markers (CRITICAL for Detection) */
        .scan-marker { 
            width: 25px; height: 25px; background: black; position: absolute; z-index: 50; 
            border: 2px solid white; /* High contrast border helps detection slightly */
        }
        
        /* Scanner Overlay */
        .scan-overlay-box {
            position: absolute; border: 4px solid rgba(34, 197, 94, 0.7); 
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
            transition: all 0.1s linear; pointer-events: none; z-index: 20;
        }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 font-sans min-h-screen pb-20">

<!-- Audio for Beep -->
<audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/90 z-[9999] hidden flex-col items-center justify-center text-white">
    <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
    <h2 class="text-xl font-bold" id="loadingText">جارٍ المعالجة...</h2>
</div>

<!-- Modal: Student Paper View -->
<div id="paperModal" class="fixed inset-0 bg-black/80 z-[5000] hidden flex justify-center items-start overflow-y-auto p-4 animate-fade-in backdrop-blur-sm">
    <div class="bg-white rounded-xl w-full max-w-6xl my-4 relative shadow-2xl flex flex-col h-[90vh]">
        <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
            <h3 class="font-bold text-lg"><i class="fa-solid fa-eye text-primary"></i> مراجعة الورقة</h3>
            <button onclick="closePaperModal()" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 font-bold transition"><i class="fa-solid fa-times"></i> إغلاق</button>
        </div>
        <div class="flex-1 overflow-auto p-6 bg-gray-200 flex flex-col lg:flex-row gap-6 justify-center">
            <!-- Digital Version -->
            <div class="flex-1 bg-white p-4 rounded shadow flex flex-col items-center">
                <h4 class="font-bold mb-2 text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded">النسخة الرقمية المصححة</h4>
                <div id="modalContent" class="scale-[0.6] origin-top transform-gpu"></div>
            </div>
            <!-- Captured Image -->
            <div class="flex-1 bg-white p-4 rounded shadow flex flex-col items-center">
                <h4 class="font-bold mb-2 text-sm bg-green-100 text-green-800 px-3 py-1 rounded">الصورة الأصلية الملتقطة</h4>
                <img id="modalOriginalImage" class="max-w-full h-auto border-2 border-gray-300 rounded" alt="Original Scan">
            </div>
        </div>
    </div>
</div>

<div class="container mx-auto px-4 py-6 max-w-[1400px]">
    
    <!-- Header -->
    <header class="bg-white rounded-2xl shadow-sm p-5 mb-6 flex flex-col lg:flex-row justify-between items-center border-b-4 border-primary">
        <div class="flex items-center gap-4 mb-4 lg:mb-0">
            <div class="bg-primary p-4 rounded-xl text-white shadow-lg shadow-primary/30">
                <i class="fa-solid fa-check-double fa-2x"></i>
            </div>
            <div>
                <h1 class="text-3xl font-display font-bold text-gray-800">OMR Master <span class="text-primary">V10.0</span></h1>
                <p class="text-sm text-gray-500 font-bold flex items-center gap-2 mt-1">
                    <span id="cvStatus" class="text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded-full text-xs border border-yellow-200">
                        <i class="fa-solid fa-circle-notch fa-spin"></i> تحميل المحرك...
                    </span>
                    <span class="text-gray-400">|</span>
                    <span>نظام التصحيح الذكي</span>
                </p>
            </div>
        </div>
        <div class="flex flex-wrap gap-3 justify-center">
            <button onclick="exportData()" class="action-btn bg-slate-700 text-white hover:bg-slate-800"><i class="fa-solid fa-cloud-arrow-down"></i> نسخ احتياطي</button>
            <label class="action-btn bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 cursor-pointer">
                <i class="fa-solid fa-cloud-arrow-up"></i> استرجاع
                <input type="file" hidden accept=".json" onchange="importData(event)">
            </label>
            <button onclick="resetApp()" class="action-btn bg-red-50 text-red-600 hover:bg-red-100 border border-red-200"><i class="fa-solid fa-trash-can"></i> تهيئة</button>
        </div>
    </header>

    <!-- Tabs Navigation -->
    <div class="bg-white rounded-2xl shadow-sm mb-6 p-2 sticky top-2 z-40 border border-gray-100">
        <div class="flex overflow-x-auto gap-2 no-scrollbar">
            <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn active">
                <i class="fa-solid fa-sliders"></i> الإعدادات
            </button>
            <button onclick="switchTab('design')" id="tab-design" class="tab-btn">
                <i class="fa-solid fa-palette"></i> التصميم والطباعة
            </button>
            <button onclick="switchTab('scan')" id="tab-scan" class="tab-btn">
                <i class="fa-solid fa-camera-retro"></i> الماسح الضوئي
            </button>
            <button onclick="switchTab('results')" id="tab-results" class="tab-btn">
                <i class="fa-solid fa-square-poll-vertical"></i> النتائج
            </button>
            <button onclick="switchTab('exams')" id="tab-exams" class="tab-btn">
                <i class="fa-solid fa-folder-open"></i> امتحاناتي
            </button>
        </div>
    </div>

    <!-- 1. SETTINGS TAB -->
    <div id="settings" class="section-panel animate-fade-in block">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
            <!-- Left Column: Basic Info -->
            <div class="md:col-span-4 space-y-6">
                <div class="card p-6">
                    <h3 class="card-title"><i class="fa-solid fa-school text-primary"></i> البيانات العامة</h3>
                    <div class="space-y-4">
                        <input type="text" id="conf-school" class="input-field" placeholder="اسم المؤسسة">
                        <input type="text" id="conf-teacher" class="input-field" placeholder="اسم الأستاذ">
                        <input type="text" id="conf-class" class="input-field" placeholder="القسم / الشعبة">
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="card-title"><i class="fa-solid fa-file-signature text-primary"></i> بيانات الفرض</h3>
                    <div class="space-y-4">
                        <input type="text" id="conf-subject" class="input-field" placeholder="المادة">
                        <input type="text" id="conf-title" class="input-field" placeholder="عنوان الفرض (مثال: الفرض الأول)">
                        <div class="flex items-center gap-2 bg-blue-50 p-2 rounded-lg border border-blue-100">
                            <span class="text-xs font-bold text-blue-800">ID:</span>
                            <input type="text" id="conf-id" class="bg-transparent font-mono font-bold text-center flex-1 outline-none" readonly>
                            <button onclick="generateID()" class="text-blue-600 hover:text-blue-800"><i class="fa-solid fa-rotate"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Layout Type Selection (New Feature) -->
                <div class="card p-6 border-l-4 border-l-purple-500">
                    <h3 class="card-title text-purple-700"><i class="fa-solid fa-layer-group"></i> نوع الورقة</h3>
                    <div class="flex flex-col gap-3 mt-3">
                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-purple-50 transition selection-radio">
                            <input type="radio" name="layoutType" value="full" class="w-5 h-5 text-purple-600" checked onchange="toggleLayoutMode()">
                            <div>
                                <span class="font-bold block text-sm">ورقة متكاملة</span>
                                <span class="text-xs text-gray-500">تتضمن نص السؤال وخيارات الإجابة</span>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-purple-50 transition selection-radio">
                            <input type="radio" name="layoutType" value="sheet" class="w-5 h-5 text-purple-600" onchange="toggleLayoutMode()">
                            <div>
                                <span class="font-bold block text-sm">ورقة إجابة فقط</span>
                                <span class="text-xs text-gray-500">شبكة مربعات فقط (مدمجة لاستيعاب المزيد)</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Right Column: Questions & Keys -->
            <div class="md:col-span-8">
                <div class="card p-6 h-full flex flex-col">
                    <div class="flex justify-between items-center border-b pb-4 mb-4">
                        <div class="flex gap-4">
                            <div>
                                <label class="text-xs font-bold block mb-1">عدد الأسئلة</label>
                                <input type="number" id="conf-q" value="20" min="1" max="100" class="input-field w-24 text-center" onchange="updateKeyGrid()">
                            </div>
                            <div>
                                <label class="text-xs font-bold block mb-1">الخيارات</label>
                                <input type="number" id="conf-o" value="4" min="2" max="6" class="input-field w-24 text-center" onchange="updateKeyGrid()">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="conf-partial" class="w-4 h-4 rounded text-primary focus:ring-primary">
                            <label for="conf-partial" class="text-sm font-bold cursor-pointer">احتساب النقطة الجزئية</label>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto max-h-[500px] border rounded-lg">
                        <table class="w-full text-sm text-center">
                            <thead class="bg-gray-100 text-gray-700 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-3">س</th>
                                    <th class="p-3">الإجابة الصحيحة</th>
                                    <th class="p-3 w-24">النقاط</th>
                                </tr>
                            </thead>
                            <tbody id="key-grid-body" class="divide-y">
                                <!-- Generated by JS -->
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-6 pt-4 border-t flex justify-end">
                        <button onclick="saveExamToMyExams()" class="bg-gradient-to-l from-primary to-secondary text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition transform hover:-translate-y-1 flex items-center gap-2">
                            <i class="fa-solid fa-save"></i> حفظ في "امتحاناتي" والانتقال للتصميم
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. DESIGN TAB -->
    <div id="design" class="section-panel hidden space-y-4">
        <div class="card p-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <h3 class="font-bold text-lg flex items-center gap-2"><i class="fa-regular fa-eye text-primary"></i> معاينة الورقة</h3>
            <div class="flex items-center gap-3 bg-gray-50 p-2 rounded-lg border">
                <span class="text-sm font-bold text-gray-600">تنسيق الطباعة:</span>
                <select id="pdf-size-select" class="bg-white border rounded px-2 py-1 text-sm outline-none focus:ring-2 focus:ring-primary">
                    <option value="1">100% (ورقة واحدة / صفحة)</option>
                    <option value="2">50% (ورقتان / صفحة)</option>
                    <option value="4">25% (4 أوراق / صفحة)</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleEdit()" id="btn-edit-mode" class="px-4 py-2 bg-yellow-50 text-yellow-700 border border-yellow-200 rounded-lg hover:bg-yellow-100 font-bold text-sm transition"><i class="fa-solid fa-pen"></i> تحرير النصوص</button>
                <button onclick="downloadPDF()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-sm shadow-lg shadow-green-200 transition flex items-center gap-2"><i class="fa-solid fa-print"></i> تحميل PDF</button>
            </div>
        </div>
        
        <!-- Viewer Container -->
        <div class="bg-slate-200/50 p-4 md:p-8 rounded-xl overflow-auto flex justify-center min-h-[600px] border border-slate-300">
            <div id="printableArea" class="paper-sheet transform transition-transform duration-300">
                <!-- Makers -->
                <div class="scan-marker" style="top:20mm; left:20mm;"></div>
                <div class="scan-marker" style="top:20mm; right:20mm;"></div>
                <div class="scan-marker" style="bottom:20mm; left:20mm;"></div>
                <div class="scan-marker" style="bottom:20mm; right:20mm;"></div>

                <!-- Content -->
                <div class="w-full h-full flex flex-col p-[25mm]">
                    <!-- Header -->
                    <div class="border-b-2 border-black pb-4 mb-4 flex justify-between items-end">
                        <div class="text-right">
                            <h2 class="font-bold text-xl mb-1" id="p-school">المؤسسة</h2>
                            <p class="text-sm text-gray-600" id="p-teacher">الأستاذ</p>
                        </div>
                        <div class="text-center">
                            <h1 class="font-black text-2xl mb-1" id="p-subject">المادة</h1>
                            <p class="text-sm font-bold bg-black text-white px-2 rounded inline-block" id="p-title">الفرض</p>
                        </div>
                        <div class="text-left">
                            <div class="border-2 border-black px-3 py-1 mb-1 rounded">
                                <span class="text-xs font-bold block">ID</span>
                                <span class="font-mono font-bold text-lg" id="p-id">0000</span>
                            </div>
                            <p class="text-xs font-bold" id="p-class">القسم</p>
                        </div>
                    </div>

                    <!-- Student Info Box -->
                    <div class="border border-black rounded p-3 mb-6 bg-gray-50 flex gap-4">
                        <div class="flex-1">
                            <span class="text-sm font-bold">الاسم الكامل:</span>
                            <div class="border-b border-dotted border-black mt-4"></div>
                        </div>
                        <div class="w-32">
                            <span class="text-sm font-bold">رقم الامتحان:</span>
                            <div class="border-b border-dotted border-black mt-4"></div>
                        </div>
                    </div>

                    <!-- Questions Container -->
                    <div id="q-container" class="flex-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. SCANNER TAB (ZipGrade Style) -->
    <div id="scan" class="section-panel hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Camera View -->
            <div class="lg:col-span-2">
                <div class="card p-4 relative bg-gray-900 rounded-xl overflow-hidden aspect-[3/4] lg:aspect-[4/3] shadow-2xl">
                    <video id="videoFeed" class="w-full h-full object-cover absolute inset-0 z-0" playsinline muted></video>
                    
                    <!-- UI Overlays -->
                    <div id="scanner-ui" class="absolute inset-0 z-10 pointer-events-none hidden">
                        <!-- Guide Box (Visual Aid) -->
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[85%] h-[85%] border-2 border-white/30 rounded-lg">
                            <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-yellow-400 rounded-tl-lg"></div>
                            <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-yellow-400 rounded-tr-lg"></div>
                            <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-yellow-400 rounded-bl-lg"></div>
                            <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-yellow-400 rounded-br-lg"></div>
                        </div>
                        
                        <!-- Status Text -->
                        <div class="absolute bottom-8 left-0 right-0 text-center">
                            <span id="scan-status" class="bg-black/60 text-white px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md">
                                ابحث عن النقاط الأربعة...
                            </span>
                        </div>
                    </div>

                    <!-- Start Button Overlay -->
                    <div id="cam-start-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900/90 z-20 text-white">
                        <i class="fa-solid fa-camera fa-4x mb-4 text-gray-400"></i>
                        <button onclick="startCamera()" class="bg-primary hover:bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg transition transform hover:scale-105">
                            <i class="fa-solid fa-play"></i> تشغيل الكاميرا
                        </button>
                        <p class="mt-4 text-sm text-gray-400">أو</p>
                        <label class="mt-2 text-blue-400 cursor-pointer hover:text-blue-300 font-bold">
                            تحميل صورة من الملفات
                            <input type="file" hidden accept="image/*" onchange="handleFileUpload(event)">
                        </label>
                    </div>
                </div>
            </div>

            <!-- Controls & Recent -->
            <div class="lg:col-span-1 space-y-4">
                <div class="card p-4">
                    <h3 class="font-bold border-b pb-2 mb-2">التحكم</h3>
                    <div class="flex flex-col gap-2">
                         <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                            <span class="text-sm font-bold">التقاط تلقائي</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="auto-capture-toggle" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                        </div>
                        <button onclick="stopCamera()" class="bg-red-100 text-red-600 py-2 rounded font-bold hover:bg-red-200 text-sm">إيقاف الكاميرا</button>
                    </div>
                </div>

                <div class="card p-4 flex-1 overflow-hidden flex flex-col">
                    <h3 class="font-bold border-b pb-2 mb-2">آخر النتائج</h3>
                    <div id="recent-scans" class="flex-1 overflow-y-auto space-y-2 text-sm">
                        <div class="text-center text-gray-400 py-4">لا توجد نتائج بعد</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. RESULTS TAB -->
    <div id="results" class="section-panel hidden space-y-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="stat-card border-blue-500">
                <div class="text-gray-500 text-xs font-bold">عدد الأوراق</div>
                <div class="text-3xl font-bold text-blue-600" id="st-count">0</div>
            </div>
            <div class="stat-card border-green-500">
                <div class="text-gray-500 text-xs font-bold">المعدل العام</div>
                <div class="text-3xl font-bold text-green-600" id="st-avg">0</div>
            </div>
            <div class="stat-card border-purple-500">
                <div class="text-gray-500 text-xs font-bold">أعلى نقطة</div>
                <div class="text-3xl font-bold text-purple-600" id="st-max">0</div>
            </div>
            <div class="stat-card border-red-500">
                <div class="text-gray-500 text-xs font-bold">أدنى نقطة</div>
                <div class="text-3xl font-bold text-red-600" id="st-min">0</div>
            </div>
        </div>
        
        <div class="card p-6">
             <h4 class="font-bold mb-4 text-sm text-gray-600">تحليل الأسئلة (نسبة الإجابة الصحيحة)</h4>
             <div class="h-64"><canvas id="qChart"></canvas></div>
        </div>

        <div class="card overflow-hidden">
            <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                <h3 class="font-bold">قائمة التلاميذ</h3>
                <button onclick="exportResultsCSV()" class="text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 shadow"><i class="fa-solid fa-file-csv"></i> Excel/CSV</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-right">
                    <thead class="bg-gray-100 text-xs font-bold text-gray-600 uppercase">
                        <tr>
                            <th class="p-4">الاسم (يدوي/آلي)</th>
                            <th class="p-4">النقطة</th>
                            <th class="p-4">النسبة</th>
                            <th class="p-4 text-center">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="res-body" class="divide-y divide-gray-100 text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 5. MY EXAMS TAB (Formerly Bank) -->
    <div id="exams" class="section-panel hidden">
        <div class="card p-6">
            <h3 class="font-bold text-xl mb-6 text-primary border-b pb-2 flex items-center gap-2">
                <i class="fa-solid fa-folder-open"></i> امتحاناتي المحفوظة
            </h3>
            <div id="exams-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>
</div>

<!-- Hidden Canvas for Processing -->
<canvas id="processCanvas" class="hidden"></canvas>

<style>
    .card { @apply bg-white rounded-xl shadow-sm border border-gray-100; }
    .input-field { @apply w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition; }
    .action-btn { @apply px-4 py-2 rounded-lg font-bold text-sm shadow-sm transition flex items-center gap-2; }
    .tab-btn { @apply px-6 py-3 font-bold text-gray-500 rounded-lg whitespace-nowrap transition hover:bg-gray-50 hover:text-gray-700 flex-1 min-w-[120px] text-center; }
    .tab-btn.active { @apply bg-primary/10 text-primary border-b-2 border-primary rounded-b-none; }
    .stat-card { @apply bg-white p-4 rounded-xl shadow-sm border-r-4 flex flex-col justify-between; }
    .section-panel { @apply min-h-[500px]; }
    
    /* Animation for auto-capture box */
    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
        100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    .capture-success { animation: pulse-green 0.5s ease-out; border-color: #22c55e !important; }
</style>

<script>
    /** 
     * --- GLOBAL STATE --- 
     */
    const app = {
        settings: { 
            school: '', teacher: '', classRoom: '', subject: '', title: '', id: '', 
            q: 20, o: 4, partial: false, layoutType: 'full', // 'full' or 'sheet'
            keys: [] 
        },
        results: [],
        savedExams: [],
        labels: ['أ', 'ب', 'ج', 'د', 'هـ', 'و'],
        cvReady: false,
        stream: null,
        isScanning: false,
        lastCaptureTime: 0
    };

    /** 
     * --- INITIALIZATION --- 
     */
    function onOpenCvReady() {
        app.cvReady = true;
        document.getElementById('cvStatus').innerHTML = '<i class="fa-solid fa-check-circle"></i> المحرك جاهز';
        document.getElementById('cvStatus').className = "text-green-700 bg-green-50 px-2 py-0.5 rounded-full text-xs border border-green-200 font-bold";
        console.log("OpenCV Loaded Successfully");
    }

    window.onload = () => {
        generateID();
        updateKeyGrid();
        loadLocalData();
        initStatsChart();
        // Set default layout radio
        document.querySelector(`input[name="layoutType"][value="${app.settings.layoutType}"]`).checked = true;
    };

    function generateID() { 
        document.getElementById('conf-id').value = Math.floor(1000 + Math.random() * 9000); 
    }

    function switchTab(id) {
        document.querySelectorAll('.section-panel').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');

        if (id !== 'scan') stopCamera();
        if (id === 'results') renderResultsTable();
        if (id === 'exams') renderExamsList();
        if (id === 'design') {
            saveCurrentSettingsToMemory(); // Sync inputs to app.settings
            renderPaper();
        }
    }

    /** 
     * --- SETTINGS LOGIC --- 
     */
    function updateKeyGrid() {
        const q = parseInt(document.getElementById('conf-q').value);
        const o = parseInt(document.getElementById('conf-o').value);
        const tbody = document.getElementById('key-grid-body');
        tbody.innerHTML = '';
        
        for (let i = 0; i < q; i++) {
            let opts = '';
            for (let j = 0; j < o; j++) {
                opts += `
                <label class="inline-flex items-center justify-center w-8 h-8 mx-1 bg-gray-50 border rounded-full cursor-pointer hover:bg-blue-50 transition">
                    <input type="checkbox" name="q${i}" value="${j}" class="hidden peer">
                    <span class="font-bold text-gray-500 peer-checked:text-blue-600">${app.labels[j]}</span>
                </label>`;
            }
            tbody.innerHTML += `
            <tr class="hover:bg-gray-50">
                <td class="p-2 font-bold text-gray-500">${i + 1}</td>
                <td class="p-2">${opts}</td>
                <td class="p-2"><input type="number" step="0.5" id="pts-${i}" value="1" class="w-16 p-1 border rounded text-center text-sm"></td>
            </tr>`;
        }
    }

    function saveCurrentSettingsToMemory() {
        const s = app.settings;
        s.school = document.getElementById('conf-school').value;
        s.teacher = document.getElementById('conf-teacher').value;
        s.classRoom = document.getElementById('conf-class').value;
        s.subject = document.getElementById('conf-subject').value;
        s.title = document.getElementById('conf-title').value;
        s.id = document.getElementById('conf-id').value;
        s.q = parseInt(document.getElementById('conf-q').value);
        s.o = parseInt(document.getElementById('conf-o').value);
        s.partial = document.getElementById('conf-partial').checked;
        s.layoutType = document.querySelector('input[name="layoutType"]:checked').value;

        s.keys = [];
        for (let i = 0; i < s.q; i++) {
            const checks = document.querySelectorAll(`input[name="q${i}"]:checked`);
            const pts = parseFloat(document.getElementById(`pts-${i}`).value) || 1;
            s.keys.push({ id: i, answers: Array.from(checks).map(c => parseInt(c.value)), points: pts });
        }
    }

    function saveExamToMyExams() {
        saveCurrentSettingsToMemory();
        const examData = {
            meta: { ...app.settings },
            date: new Date().toLocaleDateString('ar-MA'),
            timestamp: Date.now()
        };
        // Check if exists
        const existingIdx = app.savedExams.findIndex(e => e.meta.id === app.settings.id);
        if(existingIdx >= 0) app.savedExams[existingIdx] = examData;
        else app.savedExams.push(examData);
        
        saveToLocalStorage();
        alert('تم حفظ الامتحان في "امتحاناتي" بنجاح!');
        switchTab('design');
    }

    function toggleLayoutMode() {
        // Just visual update, actual logic is in renderPaper
    }

    /** 
     * --- DESIGN & PRINTING --- 
     */
    function renderPaper(viewMode = false, studentData = null) {
        const container = viewMode ? document.getElementById('modalContent') : document.getElementById('printableArea');
        const s = app.settings;
        
        // Setup View Mode Container
        let contentDiv = container;
        if(viewMode) {
            container.innerHTML = '';
            const clone = document.getElementById('printableArea').cloneNode(true);
            clone.classList.remove('transform', 'transition-transform');
            clone.style.transform = 'none';
            clone.style.margin = '0';
            clone.id = 'modal-sheet-view';
            container.appendChild(clone);
            contentDiv = clone;
        }

        // Fill Header Data
        const setText = (id, v) => { const el = contentDiv.querySelector('#'+id); if(el) el.innerText = v || '---'; }
        setText('p-school', s.school); setText('p-teacher', s.teacher);
        setText('p-class', s.classRoom); setText('p-subject', s.subject);
        setText('p-title', s.title); setText('p-id', s.id);

        // Adjust Layout Classes
        const qc = contentDiv.querySelector('#q-container');
        const sheet = contentDiv; // The paper-sheet div
        
        qc.innerHTML = '';
        
        if (s.layoutType === 'sheet') {
            sheet.classList.add('compact-mode');
            // Grid Layout for Answer Sheet Only
            qc.className = "flex flex-wrap content-start";
            
            for (let i = 0; i < s.q; i++) {
                let bubbles = generateBubblesHTML(i, s.o, viewMode, studentData);
                qc.innerHTML += `
                <div class="q-row">
                    <span class="font-bold text-sm w-6 text-center">${i+1}</span>
                    <div class="bubble-container">${bubbles}</div>
                </div>`;
            }

        } else {
            // Full Mode (Table with Question Text)
            sheet.classList.remove('compact-mode');
            qc.className = "w-full";
            
            let html = `<table class="w-full border-collapse" style="table-layout: fixed;">`;
            for(let i=0; i<s.q; i++) {
                let bubbles = generateBubblesHTML(i, s.o, viewMode, studentData);
                html += `
                <tr class="break-inside-avoid">
                    <td class="border border-black p-2 font-bold text-center w-10 bg-gray-50">${i+1}</td>
                    <td class="border border-black p-2 bg-white relative align-top">
                        ${viewMode ? `نص السؤال ${i+1}` : `<div class="tiny-edit min-h-[40px]">أدخل نص السؤال هنا...</div>`}
                    </td>
                    <td class="border border-black p-2 w-[35%] align-middle bg-gray-50">
                        <div class="bubble-container justify-center">${bubbles}</div>
                    </td>
                </tr>`;
            }
            html += `</table>`;
            qc.innerHTML = html;
            if(!viewMode) initTinyMCE();
        }
    }

    function generateBubblesHTML(qIdx, count, viewMode, studentData) {
        let bubbles = '';
        for (let j = 0; j < count; j++) {
            let cls = '';
            if (viewMode && studentData) {
                const keyAns = app.settings.keys[qIdx].answers;
                const studAns = studentData.answers[qIdx] || [];
                const isSelected = studAns.includes(j);
                const isCorrect = keyAns.includes(j);
                
                if (isCorrect && isSelected) cls = 'correct';
                else if (isSelected && !isCorrect) cls = 'wrong';
                else if (isCorrect && !isSelected) cls = 'missed';
            }
            bubbles += `<div class="bubble ${cls}">${app.labels[j]}</div>`;
        }
        return bubbles;
    }

    let isEditMode = false;
    function toggleEdit() {
        if(app.settings.layoutType === 'sheet') return alert('تحرير النصوص غير متاح في وضع "ورقة الإجابة فقط"');
        isEditMode = !isEditMode;
        const btn = document.getElementById('btn-edit-mode');
        if(isEditMode) {
            initTinyMCE();
            btn.innerHTML = '<i class="fa-solid fa-check"></i> إنهاء التحرير';
            btn.className = "px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm transition";
        } else {
            tinymce.remove();
            btn.innerHTML = '<i class="fa-solid fa-pen"></i> تحرير النصوص';
            btn.className = "px-4 py-2 bg-yellow-50 text-yellow-700 border border-yellow-200 rounded-lg hover:bg-yellow-100 font-bold text-sm transition";
        }
    }

    function initTinyMCE() {
        if(tinymce.get().length > 0) tinymce.remove();
        tinymce.init({ 
            selector: '.tiny-edit', inline: true, menubar: false, 
            toolbar: 'bold italic underline | forecolor backcolor | removeformat',
            language: 'ar'
        });
    }

    async function downloadPDF() {
        if(isEditMode) toggleEdit();
        
        const sizeSelect = document.getElementById('pdf-size-select').value; // 1, 2, or 4
        const element = document.getElementById('printableArea');
        
        // Show loading
        document.getElementById('loadingOverlay').classList.remove('hidden');
        document.getElementById('loadingText').innerText = "جارٍ إنشاء ملف PDF...";

        try {
            // Render High Quality Image from DOM
            const canvas = await html2canvas(element, { scale: 3, useCORS: true });
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            
            // Create PDF (A4)
            const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const pageHeight = 297;
            
            if (sizeSelect === "1") {
                // 100%
                pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pageHeight);
            } else if (sizeSelect === "2") {
                // 50% (Two sheets) - Top and Bottom
                // Scale height to 50% = 148.5mm
                pdf.addImage(imgData, 'JPEG', 0, 0, pageWidth, pageHeight/2);
                
                // Add separator line
                pdf.setLineDash([2, 2], 0);
                pdf.line(0, pageHeight/2, pageWidth, pageHeight/2);
                
                pdf.addImage(imgData, 'JPEG', 0, pageHeight/2, pageWidth, pageHeight/2);
            } else if (sizeSelect === "4") {
                // 25% (Four sheets) - Grid 2x2
                const w = pageWidth / 2;
                const h = pageHeight / 2;
                
                // Top Left
                pdf.addImage(imgData, 'JPEG', 0, 0, w, h);
                // Top Right
                pdf.addImage(imgData, 'JPEG', w, 0, w, h);
                // Bottom Left
                pdf.addImage(imgData, 'JPEG', 0, h, w, h);
                // Bottom Right
                pdf.addImage(imgData, 'JPEG', w, h, w, h);

                // Cut lines
                pdf.setLineDash([2, 2], 0);
                pdf.line(w, 0, w, pageHeight); // Vertical
                pdf.line(0, h, pageWidth, h);  // Horizontal
            }
            
            pdf.save(`${app.settings.title || 'Exam'}.pdf`);

        } catch (error) {
            console.error(error);
            alert("حدث خطأ أثناء إنشاء PDF");
        } finally {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    }

    /** 
     * --- SCANNER ENGINE (ZipGrade Style) --- 
     */
    async function startCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return alert("الكاميرا غير مدعومة في هذا المتصفح");
        
        try {
            const constraints = { 
                video: { 
                    facingMode: 'environment', 
                    width: { ideal: 1920 }, 
                    height: { ideal: 1080 } 
                } 
            };
            app.stream = await navigator.mediaDevices.getUserMedia(constraints);
            const vid = document.getElementById('videoFeed');
            vid.srcObject = app.stream;
            vid.onloadedmetadata = () => {
                vid.play();
                document.getElementById('cam-start-overlay').classList.add('hidden');
                document.getElementById('scanner-ui').classList.remove('hidden');
                app.isScanning = true;
                requestAnimationFrame(scanLoop);
            };
        } catch (e) {
            alert("تعذر الوصول للكاميرا: " + e.message);
        }
    }

    function stopCamera() {
        app.isScanning = false;
        if (app.stream) app.stream.getTracks().forEach(t => t.stop());
        document.getElementById('cam-start-overlay').classList.remove('hidden');
        document.getElementById('scanner-ui').classList.add('hidden');
    }

    function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        stopCamera();
        
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            processImage(canvas, true); // True = Force process single image
        };
    }

    // Main Loop
    let stableFrames = 0;
    function scanLoop() {
        if (!app.isScanning || !app.cvReady) return;

        const vid = document.getElementById('videoFeed');
        if (vid.readyState === vid.HAVE_ENOUGH_DATA) {
            const canvas = document.getElementById('processCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = vid.videoWidth / 2; // Downscale for performance
            canvas.height = vid.videoHeight / 2;
            ctx.drawImage(vid, 0, 0, canvas.width, canvas.height);
            
            // Analyze frame
            const hasPaper = detectMarkersAndCheckAlignment(canvas);
            
            const overlay = document.querySelector('.scan-overlay-box'); // We create this dynamically in detection
            const status = document.getElementById('scan-status');

            if (hasPaper) {
                stableFrames++;
                status.innerText = "ثبت الكاميرا...";
                status.className = "bg-green-600/80 text-white px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md";
                
                // Auto capture after stability
                if (stableFrames > 10 && document.getElementById('auto-capture-toggle').checked) {
                    // Flash effect
                    document.getElementById('scanner-ui').classList.add('bg-white/50');
                    setTimeout(()=>document.getElementById('scanner-ui').classList.remove('bg-white/50'), 100);
                    
                    // Capture Full Res
                    const fullCanvas = document.createElement('canvas');
                    fullCanvas.width = vid.videoWidth; fullCanvas.height = vid.videoHeight;
                    fullCanvas.getContext('2d').drawImage(vid, 0, 0);
                    
                    processImage(fullCanvas, false);
                    stableFrames = 0; // Reset
                }
            } else {
                stableFrames = 0;
                status.innerText = "ابحث عن النقاط الأربعة...";
                status.className = "bg-black/60 text-white px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md";
            }
        }
        requestAnimationFrame(scanLoop);
    }

    function detectMarkersAndCheckAlignment(canvas) {
        let src = cv.imread(canvas);
        let gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
        
        // Threshold
        let thresh = new cv.Mat();
        cv.adaptiveThreshold(gray, thresh, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 21, 10);
        
        let contours = new cv.MatVector();
        let hier = new cv.Mat();
        cv.findContours(thresh, contours, hier, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

        let candidates = [];
        for (let i = 0; i < contours.size(); i++) {
            let cnt = contours.get(i);
            let area = cv.contourArea(cnt);
            // Filter by area relative to frame size
            if (area > (canvas.width * canvas.height * 0.001)) { 
                let peri = cv.arcLength(cnt, true);
                let approx = new cv.Mat();
                cv.approxPolyDP(cnt, approx, 0.04 * peri, true);
                if (approx.rows === 4 && cv.isContourConvex(approx)) {
                     // Check aspect ratio of the rect (should be square-ish for markers)
                     let rect = cv.boundingRect(approx);
                     let ar = rect.width / rect.height;
                     if(ar >= 0.7 && ar <= 1.3) candidates.push(rect);
                }
                approx.delete();
            }
        }

        let found = false;
        // Simple logic: if we found 4 square-like blobs roughly forming a large rect
        if (candidates.length >= 4) {
            // Sort by Y then X to find corners is complex, 
            // Simplified: Sort by Area descending, take top 4
            candidates.sort((a,b) => (b.width*b.height) - (a.width*a.height));
            let markers = candidates.slice(0, 4);
            
            // Check if they form a big enough area
            let minX = Math.min(...markers.map(r=>r.x));
            let maxX = Math.max(...markers.map(r=>r.x + r.width));
            let minY = Math.min(...markers.map(r=>r.y));
            let maxY = Math.max(...markers.map(r=>r.y + r.height));
            
            let areaW = maxX - minX;
            let areaH = maxY - minY;
            
            // If the paper fills about 40% of screen at least
            if ( (areaW * areaH) > (canvas.width * canvas.height * 0.3) ) {
                found = true;
                // Draw overlay on canvas for debug/feedback? 
                // We rely on CSS overlay mainly, but we could return coords here.
            }
        }

        src.delete(); gray.delete(); thresh.delete(); contours.delete(); hier.delete();
        return found;
    }

    function processImage(canvasInput, isManual) {
        // Play Sound
        document.getElementById('beepSound').play().catch(e=>{});

        // 1. Store the Image (Snapshot)
        const snapshot = canvasInput.toDataURL('image/jpeg', 0.8);

        // 2. Process OMR
        try {
            let src = cv.imread(canvasInput);
            let gray = new cv.Mat(); cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            let thresh = new cv.Mat(); cv.adaptiveThreshold(gray, thresh, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 51, 10);
            
            // Detect Markers again (High Res)
            let contours = new cv.MatVector(); let hier = new cv.Mat();
            cv.findContours(thresh, contours, hier, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
            
            let markers = [];
            for(let i=0; i<contours.size(); i++) {
                let rect = cv.boundingRect(contours.get(i));
                let ar = rect.width/rect.height;
                if(cv.contourArea(contours.get(i)) > 500 && ar > 0.8 && ar < 1.2) markers.push(rect);
            }

            if(markers.length < 4) {
                if(isManual) alert("لم يتم العثور على العلامات الأربعة بوضوح.");
                src.delete(); gray.delete(); thresh.delete(); contours.delete(); hier.delete();
                return;
            }

            // WARP PERSECTIVE
            // Sort markers: TL, TR, BL, BR
            // Simple sorting strategy: Y (Top/Bottom), then X (Left/Right)
            markers.sort((a,b) => a.y - b.y);
            let top = markers.slice(0, 2).sort((a,b) => a.x - b.x);
            let bottom = markers.slice(2, 4).sort((a,b) => a.x - b.x);
            
            // Source Points (Centers of markers)
            let srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
                top[0].x, top[0].y, top[1].x + top[1].width, top[1].y,
                bottom[0].x, bottom[0].y + bottom[0].height, bottom[1].x + bottom[1].width, bottom[1].y + bottom[1].height
            ]);
            
            // Dest Points (Standard A4 ratio)
            let w = 1000, h = 1414;
            let dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [0,0, w,0, 0,h, w,h]);
            
            let M = cv.getPerspectiveTransform(srcTri, dstTri);
            let warped = new cv.Mat();
            cv.warpPerspective(thresh, warped, M, new cv.Size(w, h));

            // READ BUBBLES
            const q = app.settings.q;
            const o = app.settings.o;
            let detected = [];

            // Grid Logic based on Layout Type
            // This needs calibration based on the renderPaper CSS
            // For general robustness, we assume the question block is in the bottom 70% of page
            // and we scan specifically.
            
            // Simplified grid scanner for "Full Mode" (1 col) and "Sheet Mode" (2 col usually)
            // To make this robust without complex ML, we use relative coordinates.
            
            let startY = h * 0.25; // Skip Header
            let contentH = h * 0.65;
            
            if(app.settings.layoutType === 'sheet') {
                // 2 Columns logic
                let halfQ = Math.ceil(q/2);
                let rowH = contentH / halfQ;
                
                // Col 1 (Left)
                for(let i=0; i<halfQ; i++) {
                    detected[i] = scanRow(warped, 0, w*0.45, startY + (i*rowH), rowH, o);
                }
                // Col 2 (Right)
                for(let i=halfQ; i<q; i++) {
                    detected[i] = scanRow(warped, w*0.55, w*0.45, startY + ((i-halfQ)*rowH), rowH, o);
                }
            } else {
                // 1 Column logic
                let rowH = contentH / q;
                for(let i=0; i<q; i++) {
                    // Bubbles usually on the right side in RTL, occupying ~40% width
                    // In renderPaper: <td w-[35%]>...bubbles...</td>
                    // So we scan the right-most 40% of the width
                    detected[i] = scanRow(warped, w*0.6, w*0.35, startY + (i*rowH), rowH, o);
                }
            }

            // CLEANUP
            src.delete(); gray.delete(); thresh.delete(); contours.delete(); hier.delete();
            srcTri.delete(); dstTri.delete(); M.delete(); warped.delete();

            addResult(detected, snapshot);

        } catch (e) {
            console.error(e);
            if(isManual) alert("خطأ في المعالجة: " + e.message);
        }
    }

    function scanRow(mat, xOffset, width, y, h, optionsCount) {
        let answers = [];
        let bubbleW = width / optionsCount;
        
        for(let j=0; j<optionsCount; j++) {
            // ROI Center
            let bx = xOffset + (j * bubbleW);
            let by = y;
            
            // Define small box inside bubble area
            let rect = new cv.Rect(bx + bubbleW*0.25, by + h*0.25, bubbleW*0.5, h*0.5);
            
            // Boundary checks
            if (rect.x >= 0 && rect.y >= 0 && rect.x + rect.width < mat.cols && rect.y + rect.height < mat.rows) {
                let roi = mat.roi(rect);
                let count = cv.countNonZero(roi);
                let totalPixels = rect.width * rect.height;
                
                // If > 40% pixels are white (inverted logic: bubbles are white on black bg in thresh), 
                // Wait, Threshold_Binary_Inv makes ink -> White (255).
                // So filled bubble = High White Count.
                if(count > totalPixels * 0.45) {
                    answers.push(j);
                }
                roi.delete();
            }
        }
        return answers;
    }

    function addResult(answers, snapshot) {
        // Scoring
        let score = 0; let totalP = 0;
        app.settings.keys.forEach((key, i) => {
            if(i >= answers.length || !answers[i]) return;
            totalP += key.points;
            const stud = answers[i];
            const corr = key.answers;
            
            if(JSON.stringify(stud.sort()) === JSON.stringify(corr.sort())) {
                score += key.points;
            } else if(app.settings.partial) {
                const correctPicks = stud.filter(x => corr.includes(x)).length;
                const wrongPicks = stud.filter(x => !corr.includes(x)).length;
                if(wrongPicks === 0 && corr.length > 0) score += (correctPicks / corr.length) * key.points;
            }
        });

        const res = { 
            id: Date.now(), 
            name: `ورقة ${app.results.length + 1}`, 
            score: parseFloat(score.toFixed(2)), 
            total: totalP, 
            percentage: Math.round((score/totalP)*100),
            answers, 
            snapshot // Storing the image
        };
        
        app.results.push(res);
        saveToLocalStorage();
        updateRecentList(res);
        
        // Brief toast notification
        const status = document.getElementById('scan-status');
        const oldText = status.innerText;
        status.innerText = `تم التصحيح: ${res.score}/${res.total}`;
        status.className = "bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg";
        setTimeout(() => {
             status.innerText = oldText;
             status.className = "bg-green-600/80 text-white px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md";
        }, 2000);
    }

    function updateRecentList(res) {
        const list = document.getElementById('recent-scans');
        const item = `
        <div class="bg-white p-2 rounded border-l-4 ${res.percentage >= 50 ? 'border-green-500' : 'border-red-500'} shadow-sm flex justify-between items-center animate-fade-in">
            <div>
                <div class="font-bold">${res.name}</div>
                <div class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</div>
            </div>
            <div class="font-bold text-lg">${res.score}</div>
        </div>`;
        
        if(list.children[0]?.innerText === "لا توجد نتائج بعد") list.innerHTML = '';
        list.insertAdjacentHTML('afterbegin', item);
    }

    /** 
     * --- RESULTS & MY EXAMS --- 
     */
    function renderResultsTable() {
        const body = document.getElementById('res-body');
        body.innerHTML = '';
        
        // Stats
        const scores = app.results.map(r => r.score);
        if (scores.length) {
            document.getElementById('st-count').innerText = scores.length;
            document.getElementById('st-avg').innerText = (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(2);
            document.getElementById('st-max').innerText = Math.max(...scores);
            document.getElementById('st-min').innerText = Math.min(...scores);
            updateChart(app.results);
        } else {
            body.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">لا توجد بيانات</td></tr>';
        }

        app.results.forEach((r, idx) => {
            body.innerHTML += `
            <tr class="hover:bg-gray-50 group">
                <td class="p-4">
                    <input type="text" value="${r.name}" onchange="updateName(${idx}, this.value)" class="bg-transparent border-b border-transparent focus:border-blue-500 outline-none w-full">
                </td>
                <td class="p-4 font-bold">${r.score} / ${r.total}</td>
                <td class="p-4">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-${r.percentage>=50?'green':'red'}-600 h-2.5 rounded-full" style="width: ${r.percentage}%"></div>
                    </div>
                    <span class="text-xs text-gray-500">${r.percentage}%</span>
                </td>
                <td class="p-4 text-center">
                    <button onclick="viewPaper(${idx})" class="text-blue-600 hover:bg-blue-50 p-2 rounded"><i class="fa-solid fa-eye"></i></button>
                    <button onclick="deleteResult(${idx})" class="text-red-600 hover:bg-red-50 p-2 rounded"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }

    function updateName(idx, val) { app.results[idx].name = val; saveToLocalStorage(); }
    function deleteResult(idx) { if(confirm('حذف؟')) { app.results.splice(idx,1); saveToLocalStorage(); renderResultsTable(); } }

    function viewPaper(idx) {
        const r = app.results[idx];
        document.getElementById('paperModal').classList.remove('hidden');
        renderPaper(true, r); // Render Digital View
        
        const imgEl = document.getElementById('modalOriginalImage');
        if (r.snapshot) {
            imgEl.src = r.snapshot;
            imgEl.classList.remove('hidden');
        } else {
            imgEl.src = '';
            imgEl.classList.add('hidden');
        }
    }
    function closePaperModal() { document.getElementById('paperModal').classList.add('hidden'); }

    function renderExamsList() {
        const grid = document.getElementById('exams-grid');
        grid.innerHTML = '';
        if(app.savedExams.length === 0) {
            grid.innerHTML = '<div class="col-span-full text-center text-gray-400 py-10">لا توجد امتحانات محفوظة. قم بإنشاء امتحان وحفظه أولاً.</div>';
            return;
        }

        app.savedExams.forEach((exam, i) => {
            grid.innerHTML += `
            <div class="bg-white border rounded-xl p-5 hover:shadow-md transition relative group">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold text-lg text-gray-800">${exam.meta.title || 'بدون عنوان'}</h4>
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-mono">${exam.meta.id}</span>
                </div>
                <p class="text-sm text-gray-600 mb-1"><i class="fa-solid fa-book"></i> ${exam.meta.subject}</p>
                <p class="text-sm text-gray-600 mb-4"><i class="fa-solid fa-users"></i> ${exam.meta.classRoom}</p>
                <div class="text-xs text-gray-400 mb-4">${exam.date}</div>
                
                <div class="flex gap-2">
                    <button onclick="loadExam(${i})" class="flex-1 bg-primary text-white py-2 rounded-lg text-sm font-bold hover:bg-blue-700">تحميل</button>
                    <button onclick="deleteExam(${i})" class="bg-red-50 text-red-600 px-3 py-2 rounded-lg hover:bg-red-100"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>`;
        });
    }

    function loadExam(i) {
        const e = app.savedExams[i];
        app.settings = { ...e.meta };
        // Populate inputs
        document.getElementById('conf-school').value = app.settings.school;
        document.getElementById('conf-teacher').value = app.settings.teacher;
        document.getElementById('conf-class').value = app.settings.classRoom;
        document.getElementById('conf-subject').value = app.settings.subject;
        document.getElementById('conf-title').value = app.settings.title;
        document.getElementById('conf-id').value = app.settings.id;
        document.getElementById('conf-q').value = app.settings.q;
        document.getElementById('conf-o').value = app.settings.o;
        document.getElementById('conf-partial').checked = app.settings.partial;
        
        // Radio logic
        const radio = document.querySelector(`input[name="layoutType"][value="${app.settings.layoutType}"]`);
        if(radio) radio.checked = true;

        updateKeyGrid();
        
        // Restore Keys
        setTimeout(() => {
            app.settings.keys.forEach((k, idx) => {
                if(idx < app.settings.q) {
                    const ptsInp = document.getElementById(`pts-${idx}`);
                    if(ptsInp) ptsInp.value = k.points;
                    k.answers.forEach(a => {
                        const cb = document.querySelector(`input[name="q${idx}"][value="${a}"]`);
                        if(cb) cb.checked = true;
                    });
                }
            });
        }, 100);

        switchTab('settings');
        alert("تم استدعاء بيانات الامتحان بنجاح");
    }

    function deleteExam(i) {
        if(confirm("هل أنت متأكد من حذف هذا الامتحان؟")) {
            app.savedExams.splice(i, 1);
            saveToLocalStorage();
            renderExamsList();
        }
    }

    /** 
     * --- CHART & UTILS --- 
     */
    let chartInst = null;
    function initStatsChart() {
        const ctx = document.getElementById('qChart').getContext('2d');
        chartInst = new Chart(ctx, {
            type: 'bar',
            data: { labels: [], datasets: [{ label: '% الإجابة الصحيحة', data: [], backgroundColor: '#2563eb', borderRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }

    function updateChart(data) {
        if(!chartInst) return;
        const q = app.settings.q;
        const stats = new Array(q).fill(0);
        
        data.forEach(r => {
            r.answers.forEach((ans, qIdx) => {
                if(qIdx < q) {
                    const key = app.settings.keys[qIdx].answers;
                    // Simple Exact Match Logic for Chart
                    if(JSON.stringify(ans.sort()) === JSON.stringify(key.sort())) stats[qIdx]++;
                }
            });
        });

        chartInst.data.labels = Array.from({length: q}, (_, i) => `س${i+1}`);
        chartInst.data.datasets[0].data = stats.map(s => Math.round((s / data.length) * 100));
        chartInst.update();
    }

    function saveToLocalStorage() {
        localStorage.setItem('omr_pro_v10', JSON.stringify({ s: app.settings, r: app.results, e: app.savedExams }));
    }

    function loadLocalData() {
        const data = JSON.parse(localStorage.getItem('omr_pro_v10'));
        if (data) {
            app.settings = { ...app.settings, ...data.s }; // Merge defaults
            app.results = data.r || [];
            app.savedExams = data.e || [];
            
            // Refill inputs
            document.getElementById('conf-school').value = app.settings.school;
            document.getElementById('conf-teacher').value = app.settings.teacher;
            document.getElementById('conf-class').value = app.settings.classRoom;
            document.getElementById('conf-subject').value = app.settings.subject;
            document.getElementById('conf-title').value = app.settings.title;
            document.getElementById('conf-id').value = app.settings.id;
            document.getElementById('conf-q').value = app.settings.q;
            document.getElementById('conf-o').value = app.settings.o;
        }
    }

    function resetApp() {
        if(confirm("تحذير: سيتم حذف جميع البيانات والامتحانات المحفوظة. هل تريد المتابعة؟")) {
            localStorage.removeItem('omr_pro_v10');
            location.reload();
        }
    }
    
    function exportData() {
        const blob = new Blob([localStorage.getItem('omr_pro_v10')], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `OMR_Backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }
    
    function importData(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                JSON.parse(evt.target.result); // Validation
                localStorage.setItem('omr_pro_v10', evt.target.result);
                location.reload();
            } catch(err) { alert("ملف غير صالح"); }
        };
        reader.readAsText(e.target.files[0]);
    }

    function exportResultsCSV() {
        let csv = "\uFEFFالاسم,المجموع,النسبة\n";
        app.results.forEach(r => {
            csv += `"${r.name}",${r.score}/${r.total},${r.percentage}%\n`;
        });
        const a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
        a.download = 'Results.csv';
        a.click();
    }
</script>
</body>
</html>
