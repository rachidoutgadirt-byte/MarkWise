<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMR Master Pro V8.0 - المحرك الحقيقي</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#0f766e', secondary: '#115e59', accent: '#f59e0b', surface: '#f8fafc', success: '#22c55e', error: '#ef4444', warning: '#eab308' },
                    fontFamily: { sans: ['Tajawal', 'sans-serif'], display: ['Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <!-- Libraries -->
    <!-- OpenCV.js (Essential for Real Processing) -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        /* PDF Styles */
        .paper-sheet {
            width: 210mm; min-height: 297mm; background: white; margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.1); display: flex; flex-direction: row;
            overflow: hidden; position: relative;
        }
        .vertical-sidebar {
            width: 15mm; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-left: 1px dashed #cbd5e1; border-right: 1px dashed #cbd5e1;
            padding: 20px 0; overflow: hidden;
        }
        .rotated-text {
            transform: rotate(-90deg); white-space: nowrap; font-family: 'Cairo', sans-serif;
            font-weight: 700; font-size: 14px; margin: 10px 0; letter-spacing: 0.5px;
        }
        /* Bubble Styles */
        .bubble-container { display: flex; justify-content: center; gap: 4px; }
        .bubble {
            width: 24px; height: 24px; border: 1.5px solid #000; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 11px; font-weight: 800; font-family: 'Arial', sans-serif;
            line-height: 1; padding-top: 1px; background: white; z-index: 10;
        }
        .bubble.correct { background-color: #22c55e !important; border-color: #22c55e; color: white; }
        .bubble.wrong { background-color: #ef4444 !important; border-color: #ef4444; color: white; }
        .bubble.missed { background-color: #fbbf24 !important; border-color: #d97706; }
        
        /* Markers for Detection - CRITICAL */
        .scan-marker {
            width: 20px; height: 20px; background: black; position: absolute; z-index: 50;
        }

        /* Debug Canvas */
        #debugCanvas { width: 100%; border: 2px solid red; display: none; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-surface text-slate-800 font-sans min-h-screen pb-20">

<!-- Processing Overlay -->
<div id="processingOverlay" class="fixed inset-0 bg-black/90 z-[9999] hidden flex-col items-center justify-center text-white">
    <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
    <h2 class="text-xl font-bold">جارٍ معالجة الصورة...</h2>
    <p class="text-sm text-gray-400 mt-2">يتم تحليل الفقاعات وتصحيح الانحراف</p>
    <canvas id="debugCanvas" class="mt-4 max-w-[300px]"></canvas> <!-- For debug visualization -->
</div>

<!-- Modal: Student Paper View -->
<div id="paperModal" class="fixed inset-0 bg-black/80 z-[5000] hidden flex justify-center items-start overflow-y-auto p-4 animate-fade-in">
    <div class="bg-white rounded-lg w-full max-w-4xl my-8 relative">
        <button onclick="closePaperModal()" class="absolute top-4 left-4 bg-red-500 text-white w-8 h-8 rounded-full z-50 hover:bg-red-600"><i class="fa-solid fa-times"></i></button>
        <div id="modalContent" class="p-8 flex justify-center bg-gray-100"></div>
    </div>
</div>

<div class="container mx-auto px-4 py-6 max-w-[1400px]">
    
    <!-- Header -->
    <header class="bg-white rounded-xl shadow-sm p-4 mb-6 flex flex-col lg:flex-row justify-between items-center border-b-4 border-primary">
        <div class="flex items-center gap-3 mb-4 lg:mb-0">
            <div class="bg-primary/10 p-3 rounded-lg text-primary"><i class="fa-solid fa-microchip fa-xl"></i></div>
            <div>
                <h1 class="text-2xl font-display font-bold text-gray-800">OMR Master <span class="text-primary">V8.0</span></h1>
                <p class="text-xs text-green-600 font-bold" id="cvStatus">جاري تحميل محرك المعالجة...</p>
            </div>
        </div>
        <div class="flex flex-wrap gap-2 justify-center">
            <button onclick="resetApp()" class="px-3 py-2 bg-red-50 text-red-600 rounded hover:bg-red-100 text-sm font-bold"><i class="fa-solid fa-trash"></i> تهيئة</button>
        </div>
    </header>

    <!-- Tabs -->
    <div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden sticky top-0 z-40 border-b border-gray-200">
        <div class="flex overflow-x-auto no-scrollbar">
            <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn flex-1 min-w-[100px] px-4 py-4 font-bold border-b-4 text-center transition-colors border-primary text-primary bg-primary/5">الإعدادات</button>
            <button onclick="switchTab('design')" id="tab-design" class="tab-btn flex-1 min-w-[100px] px-4 py-4 font-bold border-b-4 text-center transition-colors border-transparent text-gray-500 hover:bg-gray-50">التصميم</button>
            <button onclick="switchTab('scan')" id="tab-scan" class="tab-btn flex-1 min-w-[100px] px-4 py-4 font-bold border-b-4 text-center transition-colors border-transparent text-gray-500 hover:bg-gray-50">التصحيح</button>
            <button onclick="switchTab('results')" id="tab-results" class="tab-btn flex-1 min-w-[100px] px-4 py-4 font-bold border-b-4 text-center transition-colors border-transparent text-gray-500 hover:bg-gray-50">النتائج</button>
        </div>
    </div>

    <!-- 1. SETTINGS -->
    <div id="settings" class="section-panel block space-y-6">
        <div class="bg-white p-5 rounded-xl shadow-sm">
            <h3 class="font-bold text-primary mb-4 border-b pb-2">إعدادات الفرض</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="conf-school" class="input-field w-full p-2 border rounded" placeholder="المؤسسة">
                <input type="text" id="conf-teacher" class="input-field w-full p-2 border rounded" placeholder="الأستاذ">
                <input type="text" id="conf-class" class="input-field w-full p-2 border rounded" placeholder="القسم">
                <input type="text" id="conf-subject" class="input-field w-full p-2 border rounded" placeholder="المادة">
                <input type="text" id="conf-title" class="input-field w-full p-2 border rounded" placeholder="العنوان">
                <div class="flex gap-2">
                    <input type="number" id="conf-q" value="5" min="1" max="50" class="w-1/2 p-2 border rounded" onchange="updateKeyGrid()">
                    <input type="number" id="conf-o" value="4" min="2" max="5" class="w-1/2 p-2 border rounded" onchange="updateKeyGrid()">
                </div>
            </div>
        </div>
        
        <div class="bg-white p-5 rounded-xl shadow-sm">
            <h3 class="font-bold text-primary mb-4 border-b pb-2">مفتاح الإجابة</h3>
            <div class="overflow-x-auto max-h-64">
                <table class="w-full text-sm text-center border-collapse">
                    <tbody id="key-grid-body"></tbody>
                </table>
            </div>
            <button onclick="saveSettingsAndDesign()" class="w-full mt-4 bg-primary text-white py-3 rounded-lg font-bold">حفظ وتحديث التصميم</button>
        </div>
    </div>

    <!-- 2. DESIGN -->
    <div id="design" class="section-panel hidden">
        <div class="flex justify-between bg-white p-4 rounded-xl shadow-sm mb-4">
            <h3 class="font-bold">معاينة الورقة</h3>
            <button onclick="downloadPDF()" class="px-4 py-2 bg-green-600 text-white rounded font-bold">تحميل PDF</button>
        </div>
        <div class="bg-gray-600/10 p-4 rounded-xl overflow-auto flex justify-center">
            <div id="printableArea" class="paper-sheet">
                <!-- Markers are critical for OMR -->
                <div class="scan-marker" style="top:15mm; left:15mm;"></div> <!-- TL -->
                <div class="scan-marker" style="top:15mm; right:15mm;"></div> <!-- TR -->
                <div class="scan-marker" style="bottom:15mm; left:15mm;"></div> <!-- BL -->
                <div class="scan-marker" style="bottom:15mm; right:15mm;"></div> <!-- BR -->

                <div id="side-right" class="vertical-sidebar" style="background:#fff">
                    <span id="p-school" class="rotated-text">المؤسسة</span>
                    <span class="rotated-text text-gray-300">|</span>
                    <span id="p-teacher" class="rotated-text">الأستاذ</span>
                </div>

                <div class="flex-1 flex flex-col p-8 pt-16 pb-16 relative"> <!-- Padding for markers -->
                    <div class="border-2 border-black rounded-lg p-4 mb-6 bg-gray-50">
                        <div class="flex justify-between items-end gap-4 h-full font-bold">
                            <div class="flex-1">الاسم: <span class="border-b-2 border-dotted border-gray-500 w-full inline-block"></span></div>
                            <div class="w-24">الرقم: <span class="border-b-2 border-dotted border-gray-500 w-full inline-block"></span></div>
                        </div>
                    </div>
                    <div id="q-container" class="flex-1 border border-black"></div>
                </div>

                <div id="side-left" class="vertical-sidebar" style="background:#fff">
                    <span id="p-subject" class="rotated-text">المادة</span>
                    <span class="rotated-text text-gray-300">|</span>
                    <span id="p-class" class="rotated-text font-bold">القسم</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. SCAN (REAL ENGINE) -->
    <div id="scan" class="section-panel hidden">
        <div class="bg-white p-4 rounded-xl shadow-sm text-center max-w-lg mx-auto">
            <h3 class="font-bold text-xl mb-4">المسح الضوئي (محرك OpenCV)</h3>
            
            <div class="relative bg-black rounded-lg overflow-hidden aspect-[3/4] mb-4 shadow-xl">
                <video id="videoFeed" class="w-full h-full object-cover hidden" playsinline autoplay></video>
                <img id="capturedImage" class="w-full h-full object-contain hidden">
                <div id="camPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-500 flex-col">
                    <i class="fa-solid fa-camera fa-3x mb-2"></i>
                    <p>الكاميرا جاهزة</p>
                </div>
                <!-- Alignment Grid Overlay -->
                <div class="absolute inset-0 border-2 border-green-500/50 pointer-events-none" style="margin: 15%;"></div>
                <p class="absolute bottom-2 inset-x-0 text-white/80 text-xs pointer-events-none z-10">ضع العلامات السوداء الأربعة داخل الإطار</p>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="startCamera()" class="bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 flex justify-center items-center gap-2">
                    <i class="fa-solid fa-video"></i> تشغيل الكاميرا
                </button>
                <button onclick="captureAndProcess()" id="btn-capture" class="bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fa-solid fa-camera-retro"></i> تصحيح فوري
                </button>
            </div>
            
            <label class="block w-full bg-gray-100 text-gray-700 py-3 rounded-lg border border-dashed border-gray-400 cursor-pointer hover:bg-gray-200 font-bold">
                <i class="fa-solid fa-upload"></i> رفع صورة من المعرض
                <input type="file" hidden accept="image/*" onchange="handleFileUpload(event)">
            </label>
        </div>
    </div>

    <!-- 4. RESULTS -->
    <div id="results" class="section-panel hidden">
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="font-bold text-lg mb-4 text-primary">النتائج المسجلة</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-right">
                    <thead class="bg-gray-50 text-xs uppercase font-bold text-gray-600">
                        <tr><th class="p-3">الاسم</th><th class="p-3">النتيجة</th><th class="p-3">التفاصيل</th></tr>
                    </thead>
                    <tbody id="res-body" class="text-sm divide-y"></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Hidden Canvas for OpenCV Processing -->
<canvas id="processCanvas" style="display:none;"></canvas>

<script>
    /** --- CORE STATE --- **/
    const app = {
        settings: { school: '', teacher: '', classRoom: '', subject: '', title: '', q: 5, o: 4, keys: [] },
        results: [],
        labels: ['أ', 'ب', 'ج', 'د', 'هـ'],
        cvReady: false,
        stream: null
    };

    /** --- INITIALIZATION --- **/
    function onOpenCvReady() {
        app.cvReady = true;
        document.getElementById('cvStatus').innerText = "✅ المحرك جاهز";
        document.getElementById('cvStatus').className = "text-xs text-green-600 font-bold";
    }

    window.onload = () => { updateKeyGrid(); };

    function switchTab(id) {
        document.querySelectorAll('.section-panel').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.replace('border-primary', 'border-transparent'));
        document.getElementById('tab-'+id).classList.replace('border-transparent', 'border-primary');
        if(id !== 'scan') stopCamera();
        if(id === 'results') renderResults();
    }

    /** --- SETTINGS & DESIGN --- **/
    function updateKeyGrid() {
        const q = document.getElementById('conf-q').value;
        const o = document.getElementById('conf-o').value;
        const body = document.getElementById('key-grid-body');
        body.innerHTML = '';
        for(let i=0; i<q; i++) {
            let opts = '';
            for(let j=0; j<o; j++) opts += `<label class="mx-1"><input type="checkbox" name="q${i}" value="${j}" class="mr-1">${app.labels[j]}</label>`;
            body.innerHTML += `<tr class="border-b"><td class="p-2 font-bold">${i+1}</td><td class="p-2">${opts}</td></tr>`;
        }
    }

    function saveSettingsAndDesign() {
        const s = app.settings;
        s.school = document.getElementById('conf-school').value;
        s.teacher = document.getElementById('conf-teacher').value;
        s.classRoom = document.getElementById('conf-class').value;
        s.subject = document.getElementById('conf-subject').value;
        s.title = document.getElementById('conf-title').value;
        s.q = parseInt(document.getElementById('conf-q').value);
        s.o = parseInt(document.getElementById('conf-o').value);
        
        s.keys = [];
        for(let i=0; i<s.q; i++) {
            const checks = document.querySelectorAll(`input[name="q${i}"]:checked`);
            s.keys.push(Array.from(checks).map(c => parseInt(c.value)));
        }

        renderPaper();
        switchTab('design');
    }

    function renderPaper(viewMode = false, studentData = null) {
        const area = viewMode ? document.getElementById('modalContent') : document.getElementById('printableArea');
        const s = app.settings;
        
        // Clone for view mode
        let container = viewMode ? document.createElement('div') : document.getElementById('printableArea');
        if(viewMode) {
            container.className = 'paper-sheet scale-90 origin-top';
            container.innerHTML = document.getElementById('printableArea').innerHTML;
            area.innerHTML = ''; area.appendChild(container);
        }

        // Set Texts
        const setT = (id, v) => { const e = container.querySelector('#'+id); if(e) e.innerText = v; }
        setT('p-school', s.school); setT('p-teacher', s.teacher);
        setT('p-class', s.classRoom); setT('p-subject', s.subject);

        // Build Grid
        let html = `<table class="w-full border-collapse" style="table-layout: fixed;">
            <thead class="bg-gray-100"><tr><th class="border border-black p-2 w-10">ر.ت</th><th class="border border-black p-2">الإجابة</th></tr></thead><tbody>`;
        
        for(let i=0; i<s.q; i++) {
            let bubbles = '';
            for(let j=0; j<s.o; j++) {
                let cls = '';
                if(viewMode && studentData) {
                    const k = s.keys[i]; const ans = studentData.answers[i] || [];
                    const sel = ans.includes(j); const cor = k.includes(j);
                    if(cor && sel) cls='correct'; else if(sel && !cor) cls='wrong'; else if(cor && !sel) cls='missed';
                }
                bubbles += `<div class="bubble ${cls}">${app.labels[j]}</div>`;
            }
            html += `<tr><td class="border border-black p-2 font-bold text-center">${i+1}</td><td class="border border-black p-1"><div class="bubble-container">${bubbles}</div></td></tr>`;
        }
        html += '</tbody></table>';
        container.querySelector('#q-container').innerHTML = html;
    }

    /** --- CAMERA & REAL PROCESSING --- **/
    async function startCamera() {
        const vid = document.getElementById('videoFeed');
        try {
            app.stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: {ideal: 1920}, height: {ideal: 1080} } 
            });
            vid.srcObject = app.stream;
            vid.classList.remove('hidden');
            document.getElementById('camPlaceholder').classList.add('hidden');
            document.getElementById('capturedImage').classList.add('hidden');
            document.getElementById('btn-capture').disabled = false;
        } catch(e) { alert("تعذر فتح الكاميرا: " + e.message); }
    }

    function stopCamera() {
        if(app.stream) app.stream.getTracks().forEach(t => t.stop());
        document.getElementById('videoFeed').classList.add('hidden');
    }

    function handleFileUpload(e) {
        const file = e.target.files[0];
        if(!file) return;
        stopCamera();
        const img = document.getElementById('capturedImage');
        img.src = URL.createObjectURL(file);
        img.classList.remove('hidden');
        document.getElementById('camPlaceholder').classList.add('hidden');
        document.getElementById('btn-capture').disabled = false;
    }

    function captureAndProcess() {
        if(!app.cvReady) return alert("محرك المعالجة لم يحمل بعد");
        
        const vid = document.getElementById('videoFeed');
        const imgEl = document.getElementById('capturedImage');
        const canvas = document.getElementById('processCanvas');
        const ctx = canvas.getContext('2d');
        
        // 1. Get Image Data
        let width, height;
        if(!vid.classList.contains('hidden')) {
            width = vid.videoWidth; height = vid.videoHeight;
            canvas.width = width; canvas.height = height;
            ctx.drawImage(vid, 0, 0, width, height);
        } else {
            const img = new Image();
            img.src = imgEl.src;
            img.onload = () => {
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                performOMR(canvas);
            };
            return;
        }
        performOMR(canvas);
    }

    /** --- THE OPENCV OMR LOGIC --- **/
    function performOMR(canvas) {
        document.getElementById('processingOverlay').classList.remove('hidden'); // Show spinner
        
        setTimeout(() => {
            try {
                let src = cv.imread(canvas);
                let gray = new cv.Mat();
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                
                // 1. Thresholding
                let thresh = new cv.Mat();
                cv.adaptiveThreshold(gray, thresh, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 51, 10);
                
                // 2. Find Contours (Look for the 4 markers)
                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                
                let markers = [];
                for(let i=0; i<contours.size(); i++) {
                    let c = contours.get(i);
                    let area = cv.contourArea(c);
                    let rect = cv.boundingRect(c);
                    let ar = rect.width / rect.height;
                    
                    // Filter for square-ish shapes of reasonable size (Markers)
                    // Note: These values depend on resolution, using proportional logic is better but sticking to safe ranges
                    if (area > 500 && area < 10000 && ar > 0.8 && ar < 1.2) {
                        markers.push(rect);
                    }
                }

                // If we can't find 4 markers, assume full image is the paper (fallback)
                // In a robust app, we'd warn user. Here we proceed with "Best Effort".
                let warped = thresh; 
                
                if (markers.length === 4) {
                    // Sort markers: TL, TR, BL, BR
                    markers.sort((a,b) => a.y - b.y); // Top 2 vs Bottom 2
                    let top = markers.slice(0,2).sort((a,b) => a.x - b.x);
                    let bottom = markers.slice(2,4).sort((a,b) => a.x - b.x);
                    
                    // Perspective Transform Logic could go here.
                    // For Simplicity/Stability in this demo: We assume alignment is "Okay" 
                    // and just crop to the bounding box of the 4 markers.
                    let x = top[0].x;
                    let y = top[0].y;
                    let w = top[1].x - x + top[1].width;
                    let h = bottom[0].y - y + bottom[0].height;
                    
                    let rectROI = new cv.Rect(x, y, w, h);
                    warped = thresh.roi(rectROI);
                } else {
                    // console.warn("Markers not found perfectly, attempting full scan");
                }
                
                // 3. Analyze Grid
                // We assume the Question Area is roughly the middle 80% vertically and central horizontally
                // We slice the image into Q rows
                const qCount = app.settings.q;
                const oCount = app.settings.o;
                
                let detectedAnswers = [];
                let rowHeight = warped.rows / (qCount + 2); // +2 for header/footer margins approximation
                
                // Debug Visualization
                let debugCtx = document.getElementById('debugCanvas').getContext('2d');
                document.getElementById('debugCanvas').width = warped.cols;
                document.getElementById('debugCanvas').height = warped.rows;
                cv.imshow('debugCanvas', warped);

                for(let i=0; i<qCount; i++) {
                    // Estimate Row Y position (skipping header roughly)
                    // This is "Hardcoded Logic" based on the Design Template structure
                    // In Design: Header takes ~15%, Q-Table takes rest.
                    let startY = Math.floor((warped.rows * 0.25) + (i * (warped.rows * 0.65 / qCount)));
                    let rowH = Math.floor(warped.rows * 0.65 / qCount);
                    
                    // Slice Row
                    if(startY + rowH > warped.rows) break;
                    let rowRect = new cv.Rect(0, startY, warped.cols, rowH);
                    let rowMat = warped.roi(rowRect);
                    
                    // Scan Columns (Bubbles) inside this row
                    // Bubbles are usually on the LEFT side in RTL table (Answer col)
                    // The Design table has 2 cols: ID (Right), Answer (Left).
                    // Answer col is roughly 50% width on left.
                    
                    let rowAns = [];
                    let colWidth = (rowMat.cols * 0.5) / oCount; // distributing left half among options
                    
                    for(let j=0; j<oCount; j++) {
                        // In RTL, bubbles might be laid out Right-to-Left or Left-to-Right inside the cell.
                        // Based on HTML `flex-direction: row` (default LTR even in RTL dir usually unless specified),
                        // but let's assume visual order: Option 0 is left-most or right-most?
                        // Let's assume standard visual: bubble 1, bubble 2...
                        
                        // We extract a small box (ROI) for the bubble
                        // Centering the ROI is key.
                        let bx = Math.floor((rowMat.cols * 0.1) + (j * colWidth)); // Offset from left
                        let by = Math.floor(rowMat.rows * 0.2);
                        let bw = Math.floor(colWidth * 0.6);
                        let bh = Math.floor(rowMat.rows * 0.6);
                        
                        if(bx+bw < rowMat.cols) {
                            let bubbleROI = rowMat.roi(new cv.Rect(bx, by, bw, bh));
                            let count = cv.countNonZero(bubbleROI);
                            let totalPixels = bw * bh;
                            
                            // Threshold: if > 30% pixels are white (inverted black), it's filled
                            if(count > totalPixels * 0.35) {
                                rowAns.push(j);
                            }
                            bubbleROI.delete();
                        }
                    }
                    detectedAnswers.push(rowAns);
                    rowMat.delete();
                }

                // 4. Cleanup & Calculate Score
                src.delete(); gray.delete(); thresh.delete(); contours.delete(); hierarchy.delete();
                if(warped !== thresh) warped.delete();
                
                calculateScore(detectedAnswers);

            } catch(e) {
                alert("خطأ أثناء المعالجة: " + e.message);
                document.getElementById('processingOverlay').classList.add('hidden');
            }
        }, 500); // Small delay to allow UI to render spinner
    }

    function calculateScore(answers) {
        let score = 0;
        const keys = app.settings.keys;
        
        answers.forEach((ans, idx) => {
            if(idx >= keys.length) return;
            const key = keys[idx];
            // Exact match logic
            if(JSON.stringify(ans.sort()) === JSON.stringify(key.sort())) score++;
        });

        // Save Result
        const res = {
            id: Date.now(),
            name: "ورقة مصححة " + (app.results.length + 1),
            score: score,
            total: app.settings.q,
            answers: answers
        };
        app.results.push(res);
        
        document.getElementById('processingOverlay').classList.add('hidden');
        alert(`تم التصحيح! النتيجة: ${score} / ${app.settings.q}`);
        
        // Show result paper immediately
        document.getElementById('paperModal').classList.remove('hidden');
        renderPaper(true, res);
    }

    /** --- HELPERS --- **/
    async function downloadPDF() {
        const el = document.getElementById('printableArea');
        const canvas = await html2canvas(el, { scale: 2 });
        const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
        pdf.addImage(canvas.toDataURL('image/jpeg'), 'JPEG', 0, 0, 210, 297);
        pdf.save('exam.pdf');
    }

    function renderResults() {
        const b = document.getElementById('res-body'); b.innerHTML='';
        app.results.forEach(r => {
            b.innerHTML += `<tr class="border-b"><td class="p-3 font-bold">${r.name}</td><td class="p-3 font-bold text-primary">${r.score}/${r.total}</td><td class="p-3"><button onclick='viewRes(${JSON.stringify(r)})' class="text-blue-600">عرض</button></td></tr>`;
        });
    }

    function viewRes(r) {
        document.getElementById('paperModal').classList.remove('hidden');
        renderPaper(true, r);
    }
    
    function closePaperModal() { document.getElementById('paperModal').classList.add('hidden'); }
    function resetApp() { location.reload(); }
</script>
</body>
</html>
