<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMR Master Pro V9.0 - النسخة الكاملة</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#0f766e', secondary: '#115e59', surface: '#f8fafc', success: '#22c55e', error: '#ef4444', warning: '#eab308' },
                    fontFamily: { sans: ['Tajawal', 'sans-serif'], display: ['Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <!-- Libraries -->
    <!-- OpenCV (The Brain) -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        /* PDF & Print Styles */
        .paper-sheet {
            width: 210mm; min-height: 297mm; background: white; margin: 0 auto;
            box-shadow: 0 0 25px rgba(0,0,0,0.1); display: flex; flex-direction: row;
            overflow: hidden; position: relative;
        }
        .vertical-sidebar {
            width: 15mm; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-left: 1px dashed #cbd5e1; border-right: 1px dashed #cbd5e1;
            padding: 20px 0; overflow: hidden;
        }
        .rotated-text {
            transform: rotate(-90deg); white-space: nowrap; font-family: 'Cairo', sans-serif;
            font-weight: 700; font-size: 14px; margin: 15px 0; letter-spacing: 0.5px;
        }
        
        /* Bubbles & Feedback */
        .bubble-container { display: flex; justify-content: center; gap: 4px; }
        .bubble {
            width: 24px; height: 24px; border: 1.5px solid #000; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 11px; font-weight: 800; font-family: 'Arial', sans-serif;
            background: white; z-index: 10;
        }
        /* Result Coloring */
        .bubble.correct { background-color: #22c55e !important; border-color: #22c55e; color: white; }
        .bubble.wrong { background-color: #ef4444 !important; border-color: #ef4444; color: white; }
        .bubble.missed { background-color: #fbbf24 !important; border-color: #d97706; }
        
        /* Markers (Critical for OpenCV) */
        .scan-marker { width: 20px; height: 20px; background: black; position: absolute; z-index: 50; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="bg-surface text-slate-800 font-sans min-h-screen pb-20">

<!-- Overlay: Processing -->
<div id="processingOverlay" class="fixed inset-0 bg-black/90 z-[9999] hidden flex-col items-center justify-center text-white">
    <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
    <h2 class="text-xl font-bold">جارٍ تحليل الورقة...</h2>
    <p class="text-sm text-gray-400 mt-2">يتم استخدام OpenCV لمعالجة الصورة</p>
    <!-- Debug Canvas (Optional: to see what the computer sees) -->
    <canvas id="debugCanvas" class="mt-4 border border-gray-700 max-w-[200px] hidden"></canvas>
</div>

<!-- Modal: Student Paper View -->
<div id="paperModal" class="fixed inset-0 bg-black/80 z-[5000] hidden flex justify-center items-start overflow-y-auto p-4 animate-fade-in">
    <div class="bg-white rounded-lg w-full max-w-4xl my-8 relative shadow-2xl">
        <button onclick="closePaperModal()" class="absolute top-4 left-4 bg-red-500 text-white w-8 h-8 rounded-full z-50 hover:bg-red-600 shadow-lg"><i class="fa-solid fa-times"></i></button>
        <div id="modalContent" class="p-8 flex justify-center bg-gray-100 rounded-b-lg"></div>
    </div>
</div>

<div class="container mx-auto px-4 py-6 max-w-[1400px]">
    
    <!-- Header (Restored from V7.6) -->
    <header class="bg-white rounded-xl shadow-sm p-4 mb-6 flex flex-col lg:flex-row justify-between items-center border-b-4 border-primary">
        <div class="flex items-center gap-3 mb-4 lg:mb-0">
            <div class="bg-primary/10 p-3 rounded-lg text-primary"><i class="fa-solid fa-graduation-cap fa-xl"></i></div>
            <div>
                <h1 class="text-2xl font-display font-bold text-gray-800">OMR Master <span class="text-primary">V9.0</span></h1>
                <p class="text-xs text-gray-500 font-bold flex items-center gap-1">
                    <span id="cvStatus" class="text-yellow-600"><i class="fa-solid fa-circle-notch fa-spin"></i> تحميل المحرك...</span>
                </p>
            </div>
        </div>
        <div class="flex flex-wrap gap-2 justify-center">
            <button onclick="exportData()" class="px-3 py-2 bg-slate-700 text-white rounded hover:bg-slate-800 text-sm font-bold shadow"><i class="fa-solid fa-download"></i> نسخ احتياطي</button>
            <label class="px-3 py-2 bg-slate-100 text-slate-700 rounded hover:bg-slate-200 text-sm font-bold cursor-pointer border border-slate-300 shadow">
                <i class="fa-solid fa-upload"></i> استرجاع
                <input type="file" hidden accept=".json" onchange="importData(event)">
            </label>
            <div class="w-px h-8 bg-gray-300 mx-1"></div>
            <button onclick="resetApp()" class="px-3 py-2 bg-red-50 text-red-600 rounded hover:bg-red-100 text-sm font-bold shadow"><i class="fa-solid fa-trash"></i> تهيئة</button>
        </div>
    </header>

    <!-- Tabs (Restored V7.6) -->
    <div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden sticky top-0 z-40 border-b border-gray-200">
        <div class="flex overflow-x-auto no-scrollbar">
            <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn flex-1 min-w-[120px] px-4 py-4 font-bold border-b-4 text-center transition-colors border-primary text-primary bg-primary/5">
                <i class="fa-solid fa-sliders block mb-1"></i> الإعدادات
            </button>
            <button onclick="switchTab('design')" id="tab-design" class="tab-btn flex-1 min-w-[120px] px-4 py-4 font-bold border-b-4 text-center transition-colors border-transparent text-gray-500 hover:bg-gray-50">
                <i class="fa-solid fa-pencil-ruler block mb-1"></i> التصميم
            </button>
            <button onclick="switchTab('scan')" id="tab-scan" class="tab-btn flex-1 min-w-[120px] px-4 py-4 font-bold border-b-4 text-center transition-colors border-transparent text-gray-500 hover:bg-gray-50">
                <i class="fa-solid fa-camera block mb-1"></i> التصحيح
            </button>
            <button onclick="switchTab('results')" id="tab-results" class="tab-btn flex-1 min-w-[120px] px-4 py-4 font-bold border-b-4 text-center transition-colors border-transparent text-gray-500 hover:bg-gray-50">
                <i class="fa-solid fa-chart-bar block mb-1"></i> النتائج
            </button>
            <button onclick="switchTab('bank')" id="tab-bank" class="tab-btn flex-1 min-w-[120px] px-4 py-4 font-bold border-b-4 text-center transition-colors border-transparent text-gray-500 hover:bg-gray-50 bg-yellow-50/50">
                <i class="fa-solid fa-box-archive block mb-1"></i> البنك
            </button>
        </div>
    </div>

    <!-- 1. SETTINGS (Restored Full Features) -->
    <div id="settings" class="section-panel block space-y-6 animate-fade-in">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-primary mb-4 border-b pb-2"><i class="fa-solid fa-school"></i> البيانات العامة</h3>
                <div class="space-y-3">
                    <input type="text" id="conf-school" class="input-field w-full p-2 border rounded" placeholder="المؤسسة">
                    <input type="text" id="conf-teacher" class="input-field w-full p-2 border rounded" placeholder="الأستاذ">
                    <input type="text" id="conf-class" class="input-field w-full p-2 border rounded bg-blue-50" placeholder="القسم (مثال: 2 باك)">
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-primary mb-4 border-b pb-2"><i class="fa-solid fa-file-contract"></i> تفاصيل الفرض</h3>
                <div class="space-y-3">
                    <input type="text" id="conf-subject" class="input-field w-full p-2 border rounded" placeholder="المادة">
                    <input type="text" id="conf-title" class="input-field w-full p-2 border rounded" placeholder="العنوان">
                    <div class="flex gap-2">
                        <input type="text" id="conf-id" class="w-full p-2 border rounded bg-gray-100 text-center font-mono font-bold" readonly>
                        <button onclick="generateID()" class="bg-primary text-white px-3 rounded"><i class="fa-solid fa-refresh"></i></button>
                    </div>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-primary mb-4 border-b pb-2"><i class="fa-solid fa-list-check"></i> الهيكلة</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-xs font-bold">الأسئلة</label><input type="number" id="conf-q" value="10" min="1" max="50" class="w-full p-2 border rounded" onchange="updateKeyGrid()"></div>
                    <div><label class="text-xs font-bold">الخيارات</label><input type="number" id="conf-o" value="4" min="2" max="5" class="w-full p-2 border rounded" onchange="updateKeyGrid()"></div>
                </div>
                <div class="mt-4 flex gap-2">
                    <input type="color" id="conf-col-head" value="#e0f2fe" class="h-8 w-1/2 cursor-pointer rounded">
                    <input type="color" id="conf-col-side" value="#ffffff" class="h-8 w-1/2 cursor-pointer rounded">
                </div>
            </div>
        </div>

        <!-- Advanced Key Grid -->
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="font-bold text-primary"><i class="fa-solid fa-key"></i> مفتاح الإجابة والتنقيط</h3>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="conf-partial" class="w-4 h-4">
                    <label for="conf-partial" class="text-sm font-bold cursor-pointer">احتساب النقطة الجزئية</label>
                </div>
            </div>
            <div class="overflow-x-auto max-h-80">
                <table class="w-full text-sm text-center border-collapse">
                    <thead class="bg-gray-50 text-gray-600 sticky top-0">
                        <tr><th class="p-2 border">س</th><th class="p-2 border">الإجابة الصحيحة</th><th class="p-2 border w-24">النقاط</th></tr>
                    </thead>
                    <tbody id="key-grid-body"></tbody>
                </table>
            </div>
            <div class="mt-4 text-center">
                <button onclick="saveSettingsAndDesign()" class="bg-primary text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:bg-secondary transition transform hover:-translate-y-1">
                    حفظ الإعدادات وتصميم الورقة <i class="fa-solid fa-arrow-left mr-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 2. DESIGN (Restored Layout) -->
    <div id="design" class="section-panel hidden space-y-4">
        <div class="flex justify-between bg-white p-4 rounded-xl shadow-sm">
            <h3 class="font-bold text-lg"><i class="fa-regular fa-eye"></i> معاينة الورقة</h3>
            <div class="flex gap-2">
                <button onclick="toggleEdit()" class="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200 font-bold text-sm"><i class="fa-solid fa-pen"></i> تحرير</button>
                <button onclick="downloadPDF()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-bold text-sm shadow"><i class="fa-solid fa-print"></i> PDF</button>
            </div>
        </div>
        
        <div class="bg-gray-600/10 p-4 md:p-8 rounded-xl overflow-auto flex justify-center">
            <div id="printableArea" class="paper-sheet">
                <!-- OpenCV Markers (Essential) -->
                <div class="scan-marker" style="top:15mm; left:15mm;"></div>
                <div class="scan-marker" style="top:15mm; right:15mm;"></div>
                <div class="scan-marker" style="bottom:15mm; left:15mm;"></div>
                <div class="scan-marker" style="bottom:15mm; right:15mm;"></div>

                <!-- Right Sidebar -->
                <div id="side-right" class="vertical-sidebar" style="background:var(--side-bg)">
                    <div class="h-full flex flex-col justify-center items-center gap-10">
                        <span id="p-school" class="rotated-text">المؤسسة</span>
                        <span class="rotated-text text-gray-300">|</span>
                        <span id="p-teacher" class="rotated-text">الأستاذ</span>
                    </div>
                </div>

                <!-- Main Body -->
                <div class="flex-1 flex flex-col p-8 pt-16 pb-16 relative">
                    <div class="border-2 border-black rounded-lg p-4 mb-6" style="background:var(--head-bg)">
                        <div class="flex justify-between items-end gap-4 h-full font-bold">
                            <div class="flex-1">الاسم: <span class="border-b-2 border-dotted border-gray-500 w-full inline-block"></span></div>
                            <div class="w-24">الرقم: <span class="border-b-2 border-dotted border-gray-500 w-full inline-block"></span></div>
                        </div>
                    </div>
                    <div id="q-container" class="flex-1 border border-black"></div>
                </div>

                <!-- Left Sidebar -->
                <div id="side-left" class="vertical-sidebar" style="background:var(--side-bg)">
                    <div class="h-full flex flex-col justify-center items-center gap-10">
                        <span id="p-subject" class="rotated-text">المادة</span>
                        <span class="rotated-text text-gray-300">|</span>
                        <span id="p-class" class="rotated-text font-bold text-blue-800">القسم</span>
                        <span class="rotated-text text-gray-300">|</span>
                        <span id="p-id" class="rotated-text font-mono tracking-widest">ID</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. SCAN (V7.6 UI + V8.0 Logic) -->
    <div id="scan" class="section-panel hidden">
        <div class="bg-white p-6 rounded-xl shadow-sm text-center max-w-lg mx-auto">
            <h3 class="font-bold text-xl mb-4">المسح الضوئي (محرك OpenCV)</h3>
            
            <div class="aspect-[3/4] bg-gray-900 rounded-lg mb-4 relative overflow-hidden flex items-center justify-center shadow-inner">
                <video id="videoFeed" class="w-full h-full object-cover hidden" playsinline autoplay muted></video>
                <img id="capturedImage" class="w-full h-full object-contain hidden">
                <div id="camPlaceholder" class="absolute inset-0 flex items-center justify-center text-gray-500 flex-col">
                    <i class="fa-solid fa-camera fa-3x mb-2"></i>
                    <p class="mt-2">الكاميرا مغلقة</p>
                </div>
                <!-- Guide Overlay -->
                <div class="absolute inset-8 border-2 border-dashed border-white/50 rounded pointer-events-none z-10"></div>
                <p class="absolute bottom-2 text-white/80 text-xs z-10">تأكد من ظهور المربعات السوداء الأربعة</p>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="startCamera()" class="bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow flex items-center justify-center gap-2">
                    <i class="fa-solid fa-video"></i> الكاميرا
                </button>
                <label class="bg-gray-100 text-gray-700 py-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-gray-200 font-bold shadow flex items-center justify-center gap-2">
                    <i class="fa-solid fa-image"></i> ملف
                    <input type="file" hidden accept="image/*" onchange="handleFileUpload(event)">
                </label>
            </div>

            <!-- Manual Name Input (Optional) -->
            <div class="bg-yellow-50 p-2 rounded border border-yellow-200 mb-4 text-sm text-right">
                <label class="font-bold text-yellow-800">اسم التلميذ:</label>
                <input type="text" id="scan-name" class="w-full border p-1 rounded mt-1 bg-white" placeholder="اتركه فارغاً للتوليد التلقائي">
            </div>

            <button onclick="captureAndProcess()" id="btn-capture" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-lg text-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fa-solid fa-bolt"></i> تصحيح فوري
            </button>
        </div>
    </div>

    <!-- 4. RESULTS (Restored V7.6 Stats & Charts) -->
    <div id="results" class="section-panel hidden space-y-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border-r-4 border-blue-500">
                <p class="text-xs text-gray-500">الأوراق</p><p class="text-2xl font-bold" id="st-count">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-r-4 border-green-500">
                <p class="text-xs text-gray-500">المعدل</p><p class="text-2xl font-bold" id="st-avg">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-r-4 border-purple-500">
                <p class="text-xs text-gray-500">الأعلى</p><p class="text-2xl font-bold" id="st-max">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-r-4 border-red-500">
                <p class="text-xs text-gray-500">الأدنى</p><p class="text-2xl font-bold" id="st-min">0</p>
            </div>
        </div>
        
        <div class="bg-white p-5 rounded-xl shadow-sm">
            <h4 class="font-bold mb-3 text-sm text-gray-600">تحليل الأداء (نسبة النجاح لكل سؤال)</h4>
            <div class="h-40 overflow-x-auto"><canvas id="qChart"></canvas></div>
        </div>

        <div class="bg-white p-4 rounded-t-xl border-b flex justify-between items-center">
            <div class="flex gap-2 items-center">
                <span class="text-sm font-bold">القسم:</span>
                <select id="filter-class" onchange="renderResults()" class="border p-1 rounded text-sm w-40"><option value="all">الكل</option></select>
            </div>
            <button onclick="sortResults()" class="text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200"><i class="fa-solid fa-sort"></i> ترتيب</button>
        </div>

        <div class="bg-white rounded-b-xl shadow-sm overflow-x-auto">
            <table class="w-full text-right">
                <thead class="bg-gray-50 text-gray-600 text-xs uppercase font-bold">
                    <tr><th class="p-4">الاسم</th><th class="p-4">القسم</th><th class="p-4">النتيجة</th><th class="p-4">الورقة</th></tr>
                </thead>
                <tbody id="res-body" class="text-sm divide-y"></tbody>
            </table>
        </div>
    </div>

    <!-- 5. BANK (Restored) -->
    <div id="bank" class="section-panel hidden">
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="font-bold text-lg mb-4 text-primary">بنك الفروض المحفوظة</h3>
            <div id="bank-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </div>
</div>

<!-- Hidden Canvas for OpenCV -->
<canvas id="processCanvas" style="display:none;"></canvas>

<script>
    /** --- STATE & INIT --- **/
    const app = {
        settings: { school: '', teacher: '', classRoom: '', subject: '', title: '', id:'', q: 10, o: 4, headerCol: '#e0f2fe', sideCol: '#ffffff', partial: false, keys: [] },
        results: [],
        savedExams: [],
        labels: ['أ', 'ب', 'ج', 'د', 'هـ', 'و'],
        cvReady: false,
        stream: null
    };

    function onOpenCvReady() {
        app.cvReady = true;
        const status = document.getElementById('cvStatus');
        status.innerHTML = '<i class="fa-solid fa-check-circle"></i> النظام جاهز';
        status.className = 'text-green-600 font-bold flex items-center gap-1';
        console.log("OpenCV Loaded");
    }

    window.onload = () => {
        generateID();
        updateKeyGrid();
        loadLocal();
        initStatsChart();
    };

    function generateID() { document.getElementById('conf-id').value = Math.floor(1000 + Math.random()*9000); }

    function switchTab(id) {
        document.querySelectorAll('.section-panel').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('border-primary', 'text-primary', 'bg-primary/5');
            b.classList.add('border-transparent', 'text-gray-500');
        });
        const active = document.getElementById('tab-'+id);
        active.classList.remove('border-transparent', 'text-gray-500');
        active.classList.add('border-primary', 'text-primary', 'bg-primary/5');
        
        if(id !== 'scan') stopCamera();
        if(id === 'results') renderResults();
        if(id === 'bank') renderBank();
    }

    /** --- SETTINGS & LOGIC --- **/
    function updateKeyGrid() {
        const q = parseInt(document.getElementById('conf-q').value);
        const o = parseInt(document.getElementById('conf-o').value);
        const tbody = document.getElementById('key-grid-body');
        tbody.innerHTML = '';
        for(let i=0; i<q; i++) {
            let opts = '';
            for(let j=0; j<o; j++) opts += `<label class="inline-flex items-center mx-1 bg-gray-50 px-2 py-1 rounded cursor-pointer"><input type="checkbox" name="q${i}" value="${j}" class="ml-1">${app.labels[j]}</label>`;
            tbody.innerHTML += `<tr class="border-b"><td class="p-2 font-bold">${i+1}</td><td class="p-2">${opts}</td><td class="p-2"><input type="number" step="0.5" id="pts-${i}" value="1" class="w-16 p-1 border rounded text-center"></td></tr>`;
        }
    }

    function saveSettingsAndDesign() {
        const s = app.settings;
        s.school = document.getElementById('conf-school').value;
        s.teacher = document.getElementById('conf-teacher').value;
        s.classRoom = document.getElementById('conf-class').value;
        s.subject = document.getElementById('conf-subject').value;
        s.title = document.getElementById('conf-title').value;
        s.id = document.getElementById('conf-id').value;
        s.q = parseInt(document.getElementById('conf-q').value);
        s.o = parseInt(document.getElementById('conf-o').value);
        s.headerCol = document.getElementById('conf-col-head').value;
        s.sideCol = document.getElementById('conf-col-side').value;
        s.partial = document.getElementById('conf-partial').checked;

        s.keys = [];
        for(let i=0; i<s.q; i++) {
            const checks = document.querySelectorAll(`input[name="q${i}"]:checked`);
            const pts = parseFloat(document.getElementById(`pts-${i}`).value) || 1;
            s.keys.push({ id: i, answers: Array.from(checks).map(c => parseInt(c.value)), points: pts });
        }

        renderPaper();
        switchTab('design');
        saveLocal();
    }

    /** --- DESIGN RENDERER --- **/
    function renderPaper(viewMode = false, studentData = null) {
        const area = viewMode ? document.getElementById('modalContent') : document.getElementById('printableArea');
        const s = app.settings;
        
        let container = viewMode ? document.createElement('div') : document.getElementById('printableArea');
        if(viewMode) {
            container.className = 'paper-sheet scale-90 origin-top';
            container.innerHTML = document.getElementById('printableArea').innerHTML;
            area.innerHTML = ''; area.appendChild(container);
        }

        const setText = (id, v) => { const el = container.querySelector('#'+id); if(el) el.innerText = v; }
        setText('p-school', s.school); setText('p-teacher', s.teacher);
        setText('p-class', s.classRoom); setText('p-subject', s.subject);
        setText('p-id', s.id);

        const right = container.querySelector('#side-right'); if(right) right.style.background = s.sideCol;
        const left = container.querySelector('#side-left'); if(left) left.style.background = s.sideCol;
        const head = container.querySelector('.border-2.rounded-lg'); if(head) head.style.background = s.headerCol;

        let html = `<table class="w-full border-collapse" style="table-layout: fixed;"><thead class="bg-gray-100"><tr><th class="border border-black p-2 w-10">ر.ت</th><th class="border border-black p-2 text-right">السؤال</th><th class="border border-black p-2 w-[40%] text-center">الإجابة</th></tr></thead><tbody>`;

        for(let i=0; i<s.q; i++) {
            let bubbles = '';
            for(let j=0; j<s.o; j++) {
                let cls = '';
                if(viewMode && studentData) {
                    const keyAns = s.keys[i].answers;
                    const studAns = studentData.answers[i] || [];
                    const sel = studAns.includes(j);
                    const cor = keyAns.includes(j);
                    if(cor && sel) cls='correct'; else if(sel && !cor) cls='wrong'; else if(cor && !sel) cls='missed';
                }
                bubbles += `<div class="bubble ${cls}">${app.labels[j]}</div>`;
            }
            html += `<tr><td class="border border-black p-2 font-bold text-center">${i+1}</td><td class="border border-black p-2 bg-white relative">${viewMode?`سؤال ${i+1}`:`<div class="tiny-edit">نص السؤال...</div>`}</td><td class="border border-black p-1"><div class="bubble-container">${bubbles}</div></td></tr>`;
        }
        html += '</tbody></table>';
        const qc = container.querySelector('#q-container'); if(qc) qc.innerHTML = html;
        if(!viewMode) initTiny();
    }

    let editMode = false;
    function toggleEdit() { editMode = !editMode; if(editMode) initTiny(); else tinymce.remove(); }
    function initTiny() { if(tinymce.get().length>0) tinymce.remove(); tinymce.init({ selector: '.tiny-edit', inline: true, menubar: false, toolbar: 'bold italic | forecolor' }); }
    async function downloadPDF() {
        if(editMode) toggleEdit();
        const el = document.getElementById('printableArea');
        const canvas = await html2canvas(el, { scale: 2 });
        const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
        pdf.addImage(canvas.toDataURL('image/jpeg'), 'JPEG', 0, 0, 210, 297);
        pdf.save('exam.pdf');
    }

    /** --- CAMERA & OPENCV ENGINE --- **/
    async function startCamera() {
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return alert("الكاميرا غير مدعومة");
        try {
            app.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: {ideal: 1280} } });
            const vid = document.getElementById('videoFeed');
            vid.srcObject = app.stream;
            vid.classList.remove('hidden');
            document.getElementById('camPlaceholder').classList.add('hidden');
            document.getElementById('capturedImage').classList.add('hidden');
            document.getElementById('btn-capture').disabled = false;
        } catch(e) { alert("تعذر الوصول للكاميرا: " + e.message); }
    }

    function stopCamera() {
        if(app.stream) app.stream.getTracks().forEach(t => t.stop());
        document.getElementById('videoFeed').classList.add('hidden');
    }

    function handleFileUpload(e) {
        const file = e.target.files[0];
        if(!file) return;
        stopCamera();
        const img = document.getElementById('capturedImage');
        img.src = URL.createObjectURL(file);
        img.classList.remove('hidden');
        document.getElementById('camPlaceholder').classList.add('hidden');
        document.getElementById('btn-capture').disabled = false;
    }

    function captureAndProcess() {
        if(!app.cvReady) return alert("انتظر تحميل المحرك...");
        
        const vid = document.getElementById('videoFeed');
        const imgEl = document.getElementById('capturedImage');
        const canvas = document.getElementById('processCanvas');
        const ctx = canvas.getContext('2d');

        if(!vid.classList.contains('hidden')) {
            canvas.width = vid.videoWidth; canvas.height = vid.videoHeight;
            ctx.drawImage(vid, 0, 0);
        } else {
            const img = new Image();
            img.src = imgEl.src;
            img.onload = () => { canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0); performOMR(canvas); };
            return;
        }
        performOMR(canvas);
    }

    function performOMR(canvas) {
        document.getElementById('processingOverlay').classList.remove('hidden');
        
        setTimeout(() => {
            try {
                let src = cv.imread(canvas);
                let gray = new cv.Mat(); cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                let thresh = new cv.Mat(); cv.adaptiveThreshold(gray, thresh, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 51, 10);
                
                // Find Markers
                let contours = new cv.MatVector(); let hier = new cv.Mat();
                cv.findContours(thresh, contours, hier, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                
                let markers = [];
                for(let i=0; i<contours.size(); i++) {
                    let rect = cv.boundingRect(contours.get(i));
                    let ar = rect.width/rect.height;
                    if(cv.contourArea(contours.get(i)) > 400 && ar > 0.8 && ar < 1.2) markers.push(rect);
                }

                // Perspective Warp (Simplified crop based on markers if found, else full)
                let warped = thresh;
                if(markers.length >= 4) {
                    markers.sort((a,b)=>a.y-b.y); // Top/Bottom
                    let top = markers.slice(0,2).sort((a,b)=>a.x-b.x);
                    let bot = markers.slice(2,4).sort((a,b)=>a.x-b.x);
                    let roi = new cv.Rect(top[0].x, top[0].y, top[1].x - top[0].x + top[1].width, bot[0].y - top[0].y + bot[0].height);
                    warped = thresh.roi(roi);
                }

                // Grid Analysis
                const q = app.settings.q;
                const o = app.settings.o;
                let detected = [];
                
                // Assuming Question Table is in the middle-bottom area (ignoring header)
                // Roughly split rows. This assumes good alignment.
                let rowH = (warped.rows * 0.7) / q; 
                let startY = warped.rows * 0.25; // Skip header

                for(let i=0; i<q; i++) {
                    let y = startY + (i*rowH);
                    let rowAns = [];
                    // Bubbles area is roughly 40% width, centered or slightly left in the row
                    // We iterate options
                    for(let j=0; j<o; j++) {
                        let w = (warped.cols * 0.4) / o;
                        let x = (warped.cols * 0.1) + (j*w); // Offset from left
                        
                        // Safety check
                        if(y+rowH < warped.rows && x+w < warped.cols) {
                            let roi = warped.roi(new cv.Rect(x, y + (rowH*0.2), w*0.6, rowH*0.6));
                            let count = cv.countNonZero(roi);
                            if(count > (w*0.6 * rowH*0.6) * 0.4) rowAns.push(j); // Threshold
                            roi.delete();
                        }
                    }
                    detected.push(rowAns);
                }

                src.delete(); gray.delete(); thresh.delete(); contours.delete(); hier.delete();
                if(warped !== thresh) warped.delete();
                
                finalizeScore(detected);

            } catch(e) {
                alert("خطأ: " + e.message);
                document.getElementById('processingOverlay').classList.add('hidden');
            }
        }, 500);
    }

    function finalizeScore(answers) {
        let score = 0; let totalP = 0;
        app.settings.keys.forEach((key, i) => {
            if(i >= answers.length) return;
            totalP += key.points;
            const stud = answers[i];
            const corr = key.answers;
            
            // Exact
            if(JSON.stringify(stud.sort()) === JSON.stringify(corr.sort())) {
                score += key.points;
            } else if(app.settings.partial) {
                // Partial
                const correctPicks = stud.filter(x => corr.includes(x)).length;
                const wrongPicks = stud.filter(x => !corr.includes(x)).length;
                if(wrongPicks === 0) score += (correctPicks / corr.length) * key.points;
            }
        });

        const name = document.getElementById('scan-name').value || `ورقة ${app.results.length+1}`;
        const res = { id: Date.now(), name, classRoom: app.settings.classRoom, score: parseFloat(score.toFixed(2)), total: totalP, answers };
        app.results.push(res);
        saveLocal();
        
        document.getElementById('processingOverlay').classList.add('hidden');
        viewStudentPaper(res);
    }

    /** --- RESULTS & STATS --- **/
    function renderResults() {
        const sel = document.getElementById('filter-class');
        const cls = [...new Set(app.results.map(r=>r.classRoom))].filter(Boolean);
        if(sel.options.length===1) cls.forEach(c => sel.innerHTML+=`<option value="${c}">${c}</option>`);
        
        let data = app.results;
        if(sel.value !== 'all') data = data.filter(r=>r.classRoom===sel.value);
        
        if(data.length) {
            const sc = data.map(r=>r.score);
            document.getElementById('st-count').innerText = data.length;
            document.getElementById('st-avg').innerText = (sc.reduce((a,b)=>a+b,0)/data.length).toFixed(2);
            document.getElementById('st-max').innerText = Math.max(...sc);
            document.getElementById('st-min').innerText = Math.min(...sc);
            updateChart(data);
        }

        const b = document.getElementById('res-body'); b.innerHTML='';
        data.forEach(r => {
            const pct = Math.round((r.score/r.total)*100);
            b.innerHTML += `<tr class="hover:bg-gray-50"><td class="p-4 font-bold">${r.name}</td><td class="p-4">${r.classRoom}</td><td class="p-4 font-bold ${pct>=50?'text-green-600':'text-red-600'}">${r.score}/${r.total}</td><td class="p-4"><button onclick='viewStudentPaper(${JSON.stringify(r)})' class="bg-blue-50 text-blue-600 px-3 py-1 rounded font-bold text-xs">معاينة</button></td></tr>`;
        });
    }

    let chartInst;
    function initStatsChart() {
        chartInst = new Chart(document.getElementById('qChart'), { type: 'bar', data: {labels:[], datasets:[{label:'% صحيح', data:[], backgroundColor:'#0f766e'}]}, options:{responsive:true, maintainAspectRatio:false} });
    }
    function updateChart(data) {
        const q = app.settings.q;
        const stats = new Array(q).fill(0);
        data.forEach(r => r.answers.forEach((a, i) => {
            if(i<q && JSON.stringify(a.sort())===JSON.stringify(app.settings.keys[i].answers.sort())) stats[i]++;
        }));
        chartInst.data.labels = Array.from({length:q}, (_,i)=>`س${i+1}`);
        chartInst.data.datasets[0].data = stats.map(s => Math.round((s/data.length)*100));
        chartInst.update();
    }

    function viewStudentPaper(r) { document.getElementById('paperModal').classList.remove('hidden'); renderPaper(true, r); }
    function closePaperModal() { document.getElementById('paperModal').classList.add('hidden'); }

    /** --- BANK & DATA --- **/
    function renderBank() {
        document.getElementById('bank-grid').innerHTML = app.savedExams.map((e,i) => `
        <div class="bg-white border p-4 rounded-lg hover:shadow-md relative group">
            <h4 class="font-bold text-lg">${e.meta.subject}</h4>
            <p class="text-sm text-gray-500">${e.meta.classRoom} | ${e.date}</p>
            <button onclick="loadExam(${i})" class="text-blue-600 font-bold text-sm mt-2">تحميل</button>
            <button onclick="deleteExam(${i})" class="absolute top-4 left-4 text-red-400 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash"></i></button>
        </div>`).join('');
    }
    function loadExam(i) {
        const e = app.savedExams[i]; app.settings = {...e.meta};
        document.getElementById('conf-school').value = app.settings.school;
        document.getElementById('conf-teacher').value = app.settings.teacher;
        document.getElementById('conf-class').value = app.settings.classRoom;
        document.getElementById('conf-subject').value = app.settings.subject;
        document.getElementById('conf-title').value = app.settings.title;
        document.getElementById('conf-id').value = app.settings.id;
        document.getElementById('conf-q').value = app.settings.q;
        document.getElementById('conf-o').value = app.settings.o;
        updateKeyGrid();
        app.settings.keys.forEach((k, idx) => {
            if(idx < app.settings.q) {
                document.getElementById(`pts-${idx}`).value = k.points;
                k.answers.forEach(a => { const c=document.querySelector(`input[name="q${idx}"][value="${a}"]`); if(c) c.checked=true; });
            }
        });
        switchTab('settings');
    }
    function deleteExam(i) { app.savedExams.splice(i,1); saveLocal(); renderBank(); }

    function saveLocal() { localStorage.setItem('omr_pro_v9', JSON.stringify({s:app.settings, r:app.results, b:app.savedExams})); }
    function loadLocal() { const d=JSON.parse(localStorage.getItem('omr_pro_v9')); if(d) { app.settings=d.s; app.results=d.r||[]; app.savedExams=d.b||[]; } }
    function exportData() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([localStorage.getItem('omr_pro_v9')])); a.download='backup.json'; a.click(); }
    function importData(e) { const fr=new FileReader(); fr.onload=()=>{ localStorage.setItem('omr_pro_v9', fr.result); location.reload(); }; fr.readAsText(e.target.files[0]); }
    function resetApp() { if(confirm('حذف الكل؟')) { localStorage.removeItem('omr_pro_v9'); location.reload(); } }

</script>
</body>
</html>
